<html><head><link media='all' rel='stylesheet'  href='main.css'></link><script type='text/javascript' src='require.js'></script><script type='text/javascript' src='jquery-1.7.2.js'></script><script type='text/javascript' src='main.js'></script><style type='text/css'>body { font-family: Monaco, Menlo, 'Ubuntu Mono', 'Droid Sans Mono', Consolas, monospace; font-size: 14px; }</style></head><body><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> cloud9 = </span><span class='ace_string'>&quot;http://www.28msec.com/cloud9/lib/cloud9&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> res = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/http/response&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> util = </span><span class='ace_string'>&quot;http://www.28msec.com/cloud9/lib/util&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> session = </span><span class='ace_string'>&quot;http://www.28msec.com/cloud9/lib/session&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> output = </span><span class='ace_string'>&quot;http://www.w3.org/2010/xslt-xquery-serialization&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> html = </span><span class='ace_string'>&quot;http://www.w3.org/1999/xhtml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_comment'>(: http://28msec-static.commondatastorage.googleapis.com/0.2 :)</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$cloud9:static-path</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string := </span><span class='ace_string'>&quot;http://28msec-static.commondatastorage.googleapis.com/0.2&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> cloud9:get()</span><span><br /><span class='ace_line'><span class='ace_keyword'>as</span><span class='ace_text'> element(html:html)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_support ace_function'>session:get</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span class='ace_support ace_function'>res:set-content-type</span><span class='ace_text'>(</span><span class='ace_string'>&quot;text/html&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_support ace_function'>res:set-serialization-parameters</span><span class='ace_text'>( &lt;</span><span class='ace_meta ace_tag'>output:serialization-parameters</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>   &lt;</span><span class='ace_meta ace_tag'>output:method</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>value</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>html</span><span class='ace_string'>&quot;</span><span class='ace_text'>/&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>   &lt;</span><span class='ace_meta ace_tag'>output:encoding</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>value</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>UTF-8</span><span class='ace_string'>&quot;</span><span class='ace_text'>/&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>   &lt;</span><span class='ace_meta ace_tag'>output:doctype-system</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>value</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>about:legacy-compact</span><span class='ace_string'>&quot;</span><span class='ace_text'>/&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;/</span><span class='ace_meta ace_tag'>output:serialization-parameters</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$static-path</span><span class='ace_text'> := </span><span class='ace_variable'>$cloud9:static-path</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>html</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>xmlns</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>http://www.w3.org/1999/xhtml</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>xmlns:a</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>http://ajax.org/2005/aml</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;</span><span class='ace_meta ace_tag'>head</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>profile</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>http://www.w3.org/2005/10/profile</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>meta</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>http-equiv</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>Content-Type</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>content</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>text/html; charset=UTF-8</span><span class='ace_string'>&quot;</span><span class='ace_text'>/&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>title</span><span class='ace_text'>&gt;cloud9 - Cloud9&lt;/</span><span class='ace_meta ace_tag'>title</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>meta</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>name</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>description</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>content</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>&quot;</span><span class='ace_text'>/&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>meta</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>name</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>keywords</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>content</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>&quot;</span><span class='ace_text'>/&gt;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>link</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>rel</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>icon</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>type</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>image/gif</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>href</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$static-path</span><span class='ace_text'>}</span><span class='ace_string'>/favicon.ico</span><span class='ace_string'>&quot;</span><span class='ace_text'> /&gt;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>link</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>rel</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>stylesheet</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>type</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>text/css</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>href</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$static-path</span><span class='ace_text'>}</span><span class='ace_string'>/static/ext/main/style/style.css</span><span class='ace_string'>&quot;</span><span class='ace_text'> /&gt;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>script</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>type</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>text/javascript</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>src</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>/socket.io/socket.io.js</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>script</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>script</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>type</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>text/javascript</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>src</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$static-path</span><span class='ace_text'>}</span><span class='ace_string'>/static/require.js</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>script</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>script</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>type</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>text/javascript</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>data-ace-worker-path</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>/static/js/worker</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>src</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$static-path</span><span class='ace_text'>}</span><span class='ace_string'>/static/ace/build/ace.js</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>script</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>script</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>type</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>text/javascript</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        var staticURL = &quot;{</span><span class='ace_variable'>$static-path</span><span class='ace_text'>}&quot;;</span><span><br /><span class='ace_line'><span class='ace_text'>        var sessionID = &quot;{</span><span class='ace_variable'>$session:id</span><span class='ace_text'>}&quot;;</span><span><br /><span class='ace_line'><span class='ace_text'>        var settings  = &quot;{</span><span class='ace_support ace_function'>cloud9:settings</span><span class='ace_text'>()}&quot;;</span><span><br /><span class='ace_line'><span class='ace_text'>        //</span><span class='ace_comment'>&lt;![CDATA[</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>            var baseUrl = window.location.host;</span><span><br /><span class='ace_line'><span class='ace_comment'>            window.cloud9config = {</span><span><br /><span class='ace_line'><span class='ace_comment'>                startdate: new Date(),</span><span><br /><span class='ace_line'><span class='ace_comment'>                davPrefix: &quot;/fs/workspace&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                workspaceDir: &quot;/Users/wcandillon/28msec/cloud9&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                debug: &quot;&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                sessionId: sessionID,</span><span><br /><span class='ace_line'><span class='ace_comment'>                workspaceId: &quot;Cloud9&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                name: &quot;&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                readonly: &quot;&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                projectName: &quot;Zorba&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                version: &quot;&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                staticUrl: staticURL + &quot;/static&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                socketIoUrl: &quot;socket/socket.io&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                hosted: false,</span><span><br /><span class='ace_line'><span class='ace_comment'>                settings: settings</span><span><br /><span class='ace_line'><span class='ace_comment'>            };</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>            // prevent console messages from crashing our app!</span><span><br /><span class='ace_line'><span class='ace_comment'>            if (typeof window[&quot;console&quot;] == &quot;undefined&quot;) {</span><span><br /><span class='ace_line'><span class='ace_comment'>                var K = function() {};</span><span><br /><span class='ace_line'><span class='ace_comment'>                window.console = {log:K,debug:K,dir:K,trace:K,error:K,warn:K,profileStart:K,profileEnd:K};</span><span><br /><span class='ace_line'><span class='ace_comment'>            }</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>            var RELEASE = &quot;release&quot;;</span><span><br /><span class='ace_line'><span class='ace_comment'>            var DEBUG   = &quot;debug&quot;;</span><span><br /><span class='ace_line'><span class='ace_comment'>            var FILES   = &quot;files&quot;;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>            var VERSION = window.cloud9config.debug ? DEBUG : RELEASE;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>            var apfLoc = staticURL + &quot;/static/apf-packaged/apf_&quot; + VERSION + &quot;.js&quot;;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>            var config = {&quot;baseUrl&quot;: &quot;/static&quot;,&quot;paths&quot;:{&quot;debug&quot;: staticURL + &quot;/static/v8debug/lib/v8debug&quot;,&quot;v8debug&quot;: staticURL + &quot;/static/v8debug/lib/v8debug&quot;,&quot;treehugger&quot;: staticURL + &quot;/static/treehugger/lib/treehugger&quot;,&quot;apf&quot;: staticURL + &quot;/static/apf&quot;,&quot;ace&quot;: staticURL + &quot;/static/ace/lib/ace&quot;,&quot;pilot&quot;: staticURL + &quot;/static/ace/lib/pilot&quot;,&quot;core&quot;:  staticURL + &quot;/static/core&quot;,&quot;ext&quot;: staticURL + &quot;/static/ext&quot;}};//</span><span><br /><span class='ace_line'><span class='ace_comment'>            require(config, [apfLoc], function(){</span><span><br /><span class='ace_line'><span class='ace_comment'>                var list = [&quot;core/ide&quot;, &quot;core/ext&quot;, &quot;core/util&quot;, </span><span><br /><span class='ace_line'><span class='ace_comment'>                    &quot;core/settings&quot;, &quot;ext/main/main&quot;, &quot;ext/editors/editors&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                    &quot;ace/editor&quot;];</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>                //loader.animateLoader(20);</span><span><br /><span class='ace_line'><span class='ace_comment'>                require(list, function(ide, ext, util){</span><span><br /><span class='ace_line'><span class='ace_comment'>                    var plugins = [&quot;ext/filesystem/filesystem&quot;,&quot;ext/settings/settings&quot;,&quot;ext/editors/editors&quot;,&quot;ext/themes/themes&quot;,&quot;ext/themes_default/themes_default&quot;,&quot;ext/panels/panels&quot;,&quot;ext/dockpanel/dockpanel&quot;,&quot;ext/openfiles/openfiles&quot;,&quot;ext/tree/tree&quot;,&quot;ext/save/save&quot;,&quot;ext/recentfiles/recentfiles&quot;,&quot;ext/gotofile/gotofile&quot;,&quot;ext/newresource/newresource&quot;,&quot;ext/undo/undo&quot;,&quot;ext/clipboard/clipboard&quot;,&quot;ext/searchinfiles/searchinfiles&quot;,&quot;ext/searchreplace/searchreplace&quot;,&quot;ext/quickwatch/quickwatch&quot;,&quot;ext/quicksearch/quicksearch&quot;,&quot;ext/gotoline/gotoline&quot;,&quot;ext/html/html&quot;,&quot;ext/log/log&quot;,&quot;ext/help/help&quot;,&quot;ext/code/code&quot;,&quot;ext/statusbar/statusbar&quot;,&quot;ext/imgview/imgview&quot;,&quot;ext/extmgr/extmgr&quot;,&quot;ext/runpanel/runpanel&quot;,&quot;ext/debugger/debugger&quot;,&quot;ext/noderunner/noderunner&quot;,&quot;ext/console/console&quot;,&quot;ext/consolehints/consolehints&quot;,&quot;ext/tabbehaviors/tabbehaviors&quot;,&quot;ext/tabsessions/tabsessions&quot;,&quot;ext/keybindings_default/keybindings_default&quot;,&quot;ext/watcher/watcher&quot;,&quot;ext/dragdrop/dragdrop&quot;,&quot;ext/menus/menus&quot;,&quot;ext/tooltip/tooltip&quot;,&quot;ext/sidebar/sidebar&quot;,&quot;ext/beautify/beautify&quot;,&quot;ext/offline/offline&quot;,&quot;ext/stripws/stripws&quot;,&quot;ext/testpanel/testpanel&quot;,&quot;ext/nodeunit/nodeunit&quot;,&quot;ext/zen/zen&quot;,&quot;ext/codecomplete/codecomplete&quot;,&quot;ext/vim/vim&quot;,&quot;ext/guidedtour/guidedtour&quot;,&quot;ext/quickstart/quickstart&quot;,&quot;ext/jslanguage/jslanguage&quot;,&quot;ext/autotest/autotest&quot;,&quot;ext/closeconfirmation/closeconfirmation&quot;,&quot;ext/codetools/codetools&quot;,&quot;ext/colorpicker/colorpicker&quot;,&quot;ext/revisions/revisions&quot;,&quot;ext/language/liveinspect&quot;];</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>                    var aceConfig = require(&quot;ace/config&quot;);</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>                    aceConfig.set(&quot;packaged&quot;, true);</span><span><br /><span class='ace_line'><span class='ace_comment'>                    aceConfig.set(&quot;workerPath&quot;, &quot;/static/ace/worker&quot;);</span><span><br /><span class='ace_line'><span class='ace_comment'>                    aceConfig.set(&quot;modePath&quot;,  &quot;/static/ace/mode&quot;);</span><span><br /><span class='ace_line'><span class='ace_comment'>                    aceConfig.set(&quot;themePath&quot;, &quot;/static/ace/theme&quot;);</span><span><br /><span class='ace_line'><span class='ace_comment'>                    </span><span><br /><span class='ace_line'><span class='ace_comment'>                    apf.addEventListener(&quot;load&quot;, function(){</span><span><br /><span class='ace_line'><span class='ace_comment'>                        //Load extensions</span><span><br /><span class='ace_line'><span class='ace_comment'>                        require(plugins, function(){</span><span><br /><span class='ace_line'><span class='ace_comment'>                            ide.dispatchEvent(&quot;extload&quot;, {modules: plugins});</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>                            console.log(&quot;Total Load Time &quot; </span><span><br /><span class='ace_line'><span class='ace_comment'>                                + (new Date() - window.cloud9config.startdate) + &quot;ms&quot;);</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>                            ide.addEventListener(&quot;$event.extload&quot;, function(cb){</span><span><br /><span class='ace_line'><span class='ace_comment'>                                cb();</span><span><br /><span class='ace_line'><span class='ace_comment'>                            });</span><span><br /><span class='ace_line'><span class='ace_comment'>                        });</span><span><br /><span class='ace_line'><span class='ace_comment'>                    });</span><span><br /><span class='ace_line'><span class='ace_comment'>                });</span><span><br /><span class='ace_line'><span class='ace_comment'>                preloaderImgs();</span><span><br /><span class='ace_line'><span class='ace_comment'>            });</span><span><br /><span class='ace_line'><span class='ace_comment'>            function preloaderImgs() {</span><span><br /><span class='ace_line'><span class='ace_comment'>                var preloadImgs = [</span><span><br /><span class='ace_line'><span class='ace_comment'>                    staticURL + &quot;/static/ext/main/style/images/bg-overlay.png&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                    staticURL + &quot;/static/ext/main/style/images/cover-heaeder.png&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                    staticURL + &quot;/static/ext/main/style/images/cover-logo.png&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                    staticURL + &quot;/static/ext/main/style/images/panelBg.png&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                    staticURL + &quot;/static/ext/main/style/images/editor_tab.png&quot;,</span><span><br /><span class='ace_line'><span class='ace_comment'>                    staticURL + &quot;/static/ext/main/style/images/cloud9logo_transparent.png&quot;</span><span><br /><span class='ace_line'><span class='ace_comment'>                ];</span><span><br /><span class='ace_line'><span class='ace_comment'>                if (document.images) {</span><span><br /><span class='ace_line'><span class='ace_comment'>                    var img;</span><span><br /><span class='ace_line'><span class='ace_comment'>                    for(var i = 0; i &lt; preloadImgs.length; i++) {</span><span><br /><span class='ace_line'><span class='ace_comment'>                        img = new Image();</span><span><br /><span class='ace_line'><span class='ace_comment'>                        img.src = preloadImgs[i];</span><span><br /><span class='ace_line'><span class='ace_comment'>                    }</span><span><br /><span class='ace_line'><span class='ace_comment'>                }</span><span><br /><span class='ace_line'><span class='ace_comment'>            }</span><span><br /><span class='ace_line'><span class='ace_comment'>        //]]&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;/</span><span class='ace_meta ace_tag'>script</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;/</span><span class='ace_meta ace_tag'>head</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;</span><span class='ace_meta ace_tag'>body</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>style</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>id</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>noscript</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>            &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>noscript</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>id</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>hp_header</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                    &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>id</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>logo</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                &lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>oldbro_middle_panel</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                    &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>content</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                        &lt;</span><span class='ace_meta ace_tag'>p</span><span class='ace_text'>&gt;Your browser is not supported by ajax.org. Please upgrade your browser to one of these modern browsers.&lt;/</span><span class='ace_meta ace_tag'>p</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                        &lt;</span><span class='ace_meta ace_tag'>span</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>browser_option</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                            &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>href</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>http://www.mozilla.com/firefox</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>target</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>_blank</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                                &lt;</span><span class='ace_meta ace_tag'>img</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>src</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$static-path</span><span class='ace_text'>}</span><span class='ace_string'>/static/ext/main/style/images/browsers/ff_32x32.png</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>alt</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>&quot;</span><span class='ace_text'> /&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                                &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;Mozilla Firefox&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                            &lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                        &lt;/</span><span class='ace_meta ace_tag'>span</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                        &lt;</span><span class='ace_meta ace_tag'>span</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>browser_option</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>style</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>width:50px;</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                            &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>href</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>http://www.apple.com/safari</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>target</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>_blank</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                                &lt;</span><span class='ace_meta ace_tag'>img</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>src</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$static-path</span><span class='ace_text'>}</span><span class='ace_string'>/static/ext/main/style/images/browsers/safari_32x32.png</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>alt</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>&quot;</span><span class='ace_text'> /&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                                &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;Safari&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                            &lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                        &lt;/</span><span class='ace_meta ace_tag'>span</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                        &lt;</span><span class='ace_meta ace_tag'>span</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>browser_option</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                            &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>href</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>http://www.google.com/chrome</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>target</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>_blank</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                                &lt;</span><span class='ace_meta ace_tag'>img</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>src</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$static-path</span><span class='ace_text'>}</span><span class='ace_string'>/static/ext/main/style/images/browsers/chrome_32x32.png</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>alt</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>&quot;</span><span class='ace_text'> /&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                                &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;Google Chrome&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                            &lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                        &lt;/</span><span class='ace_meta ace_tag'>span</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                        &lt;</span><span class='ace_meta ace_tag'>span</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>browser_option</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                            &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>href</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>http://www.microsoft.com/windows/internet-explorer</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>target</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>_blank</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                                &lt;</span><span class='ace_meta ace_tag'>img</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>src</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$static-path</span><span class='ace_text'>}</span><span class='ace_string'>/static/ext/main/style/images/browsers/ie_32x32.png</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>alt</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>&quot;</span><span class='ace_text'> /&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                                &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;Internet Explorer&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                            &lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                        &lt;/</span><span class='ace_meta ace_tag'>span</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                    &lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                &lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>wn_main_section_rounded</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                    &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>wnmsr_left</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                    &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>wnmsr_middle</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                    &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>wnmsr_right</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                &lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>            &lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;/</span><span class='ace_meta ace_tag'>body</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;/</span><span class='ace_meta ace_tag'>html</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> cloud9:settings()</span><span><br /><span class='ace_line'><span class='ace_keyword'>as</span><span class='ace_text'> xs:string</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$session</span><span class='ace_text'> := </span><span class='ace_support ace_function'>session:get</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>if</span><span class='ace_text'>(</span><span class='ace_support ace_function'>empty</span><span class='ace_text'>(</span><span class='ace_variable'>$session</span><span class='ace_text'>/settings)) </span><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>insert</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> &lt;</span><span class='ace_meta ace_tag'>settings</span><span class='ace_text'> /&gt; </span><span class='ace_keyword'>into</span><span class='ace_text'> </span><span class='ace_variable'>$session</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>    ();</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>util:serialize</span><span class='ace_text'>(</span><span class='ace_variable'>$session</span><span class='ace_text'>/settings)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> cloud9:save-settings(</span><span class='ace_variable'>$settings</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string)</span><span><br /><span class='ace_line'><span class='ace_keyword'>as</span><span class='ace_text'> </span><span class='ace_keyword'>empty-sequence</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$settings</span><span class='ace_text'> := </span><span class='ace_support ace_function'>util:parse</span><span class='ace_text'>(</span><span class='ace_variable'>$settings</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$session</span><span class='ace_text'> := </span><span class='ace_support ace_function'>session:get</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>replace</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> </span><span class='ace_variable'>$session</span><span class='ace_text'>/settings </span><span class='ace_keyword'>with</span><span class='ace_text'> </span><span class='ace_variable'>$settings</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>(:</span><span><br /><span class='ace_line'><span class='ace_text'> : Copyright 2010 28msec Inc.</span><span><br /><span class='ace_line'><span class='ace_text'> :)</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> guestbook = </span><span class='ace_string'>&quot;http://www.28msec.com/templates/guestbook/guestbook&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> req = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/http/request&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> resp = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/http/response&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>collection</span><span class='ace_text'> guestbook:entries </span><span class='ace_keyword'>as</span><span class='ace_text'> node()*;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;guestbook:entries&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> guestbook:add()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'> </span><span class='ace_support ace_function'>db:insert-nodes</span><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'>,</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>entry</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>author</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>req:parameter-values</span><span class='ace_text'>(</span><span class='ace_string'>&quot;author&quot;</span><span class='ace_text'>)}</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>date</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>fn:current-date</span><span class='ace_text'>()}</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>time</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>fn:current-time</span><span class='ace_text'>()}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>      {</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span class='ace_support ace_function'>req:parameter-values</span><span class='ace_text'>(</span><span class='ace_string'>&quot;text&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>      }</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;/</span><span class='ace_meta ace_tag'>entry</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>  );</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>guestbook:list</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> guestbook:list() {</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>resp:set-content-type</span><span class='ace_text'>(</span><span class='ace_string'>&quot;text/html&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$entries</span><span class='ace_text'> := </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$e</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>db:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>                  </span><span class='ace_keyword'>order</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_support ace_function'>xs:date</span><span class='ace_text'>(</span><span class='ace_variable'>$e</span><span class='ace_text'>/@date), </span><span class='ace_support ace_function'>xs:time</span><span class='ace_text'>(</span><span class='ace_variable'>$e</span><span class='ace_text'>/@time)</span><span><br /><span class='ace_line'><span class='ace_text'>                  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_variable'>$e</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> := </span><span class='ace_support ace_function'>fn:count</span><span class='ace_text'>(</span><span class='ace_variable'>$entries</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>if</span><span class='ace_text'>(</span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_constant'>0</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>then</span><span class='ace_text'>    </span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>entry</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;No entries, yet.&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$entry</span><span class='ace_text'> </span><span class='ace_keyword'>at</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_variable'>$entries</span><span class='ace_text'>[</span><span class='ace_support ace_function'>position</span><span class='ace_text'>() </span><span class='ace_keyword'>gt</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> </span><span class='ace_constant'>5</span><span class='ace_text'>]</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$numbering</span><span class='ace_text'> := </span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword'>lt</span><span class='ace_text'> </span><span class='ace_constant'>5</span><span class='ace_text'>) </span><span class='ace_keyword'>then</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'> </span><span class='ace_keyword'>else</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> ( </span><span class='ace_constant'>5</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'>) </span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>return</span><span class='ace_text'> &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>entry</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>header</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$entry</span><span class='ace_text'>/@author)}&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>content</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$entry</span><span class='ace_text'>/text()}&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>datetime</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$entry</span><span class='ace_text'>/@datetime)}&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>               &lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> s = </span><span class='ace_string'>&quot;http://www.28msec.com/cloud9/lib/socket&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> date = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/datetime&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> random = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/random&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> base64 = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/converters/base64&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> json = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/converters/json&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> req = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/http/request&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> res = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/http/response&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> sleep = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/sleep&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> store = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/store&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> j = </span><span class='ace_string'>&quot;http://john.snelson.org.uk/parsing-json-into-xquery&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>collection</span><span class='ace_text'> s:clients </span><span class='ace_keyword'>as</span><span class='ace_text'> element(client);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:clients</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:clients'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private %an:automatic %an:value-equality </span><span class='ace_keyword'>index</span><span class='ace_text'> s:client</span><span><br /><span class='ace_line'><span class='ace_keyword'>on</span><span class='ace_text'> </span><span class='ace_keyword'>nodes</span><span class='ace_text'> </span><span class='ace_support ace_function'>db:collection</span><span class='ace_text'>(</span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:clients'</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_support ace_function'>xs:string</span><span class='ace_text'>(@id) </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string;  </span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:client</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:client'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>collection</span><span class='ace_text'> s:messages </span><span class='ace_keyword'>as</span><span class='ace_text'> element(message);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:messages</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:messages'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private %an:automatic %an:value-equality </span><span class='ace_keyword'>index</span><span class='ace_text'> s:message</span><span><br /><span class='ace_line'><span class='ace_keyword'>on</span><span class='ace_text'> </span><span class='ace_keyword'>nodes</span><span class='ace_text'> </span><span class='ace_support ace_function'>db:collection</span><span class='ace_text'>(</span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:messages'</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_support ace_function'>xs:string</span><span class='ace_text'>(@session-id) </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:message</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:message'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:disconnect</span><span class='ace_text'>     := </span><span class='ace_constant'>0</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:connect</span><span class='ace_text'>        := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:heartbeat</span><span class='ace_text'>      := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:msg</span><span class='ace_text'>            := </span><span class='ace_constant'>3</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:json</span><span class='ace_text'>           := </span><span class='ace_constant'>4</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:event</span><span class='ace_text'>          := </span><span class='ace_constant'>5</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:acknowledgment</span><span class='ace_text'> := </span><span class='ace_constant'>6</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:error</span><span class='ace_text'>          := </span><span class='ace_constant'>7</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:noop</span><span class='ace_text'>           := </span><span class='ace_constant'>8</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:heartbeat-timeout</span><span class='ace_text'>  </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>20</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:connection-timeout</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>20</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:listeners</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> item()* := ();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:handshake</span><span class='ace_text'>               </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:handshake'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:transport-not-supported</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:transport-not-supported'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:supported-transports</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string+ := </span><span class='ace_string'>&quot;xhr-polling&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:transport</span><span class='ace_text'>   </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string? := ();</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:session-id</span><span class='ace_text'>  </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string? := ();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> s:id() </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string? { </span><span class='ace_variable'>$s:session-id</span><span class='ace_text'> };</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> s:on(</span><span class='ace_variable'>$event-name</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string, </span><span class='ace_variable'>$handler</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> function(*))</span><span><br /><span class='ace_line'><span class='ace_text'>as empty-sequence()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  $s:listeners :=  ($s:listeners, $event-name, $handler);</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:handler($event-name as xs:string)</span><span><br /><span class='ace_line'><span class='ace_text'>as function(*)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  for $handler at $i in $s:listeners</span><span><br /><span class='ace_line'><span class='ace_text'>  let $handler-event-name := if($handler instance of xs:string) then $handler else ()</span><span><br /><span class='ace_line'><span class='ace_text'>  where $handler-event-name = $event-name</span><span><br /><span class='ace_line'><span class='ace_text'>  return $s:listeners[$i + 1]</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare function s:clients()</span><span><br /><span class='ace_line'><span class='ace_text'>as element(client)*</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  db:collection($s:clients)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare function s:get()</span><span><br /><span class='ace_line'><span class='ace_text'>as element(client)?</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  idx:probe-index-point-value($s:client, $s:session-id)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:listen()</span><span><br /><span class='ace_line'><span class='ace_text'>as xs:string</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  try {</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      s:handshake();</span><span><br /><span class='ace_line'><span class='ace_text'>      for $message in s:messages()</span><span><br /><span class='ace_line'><span class='ace_text'>      let $type := number($message/@type)</span><span><br /><span class='ace_line'><span class='ace_text'>      return</span><span><br /><span class='ace_line'><span class='ace_text'>        switch ($type)</span><span><br /><span class='ace_line'><span class='ace_text'>          case $s:disconnect</span><span><br /><span class='ace_line'><span class='ace_text'>          return s:disconnect();</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>          case $s:msg</span><span><br /><span class='ace_line'><span class='ace_text'>          return</span><span><br /><span class='ace_line'><span class='ace_text'>            for $handler in s:handler(&quot;message&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>            return $handler($message/text());</span><span><br /><span class='ace_line'><span class='ace_text'>            </span><span><br /><span class='ace_line'><span class='ace_text'>          case $s:json</span><span><br /><span class='ace_line'><span class='ace_text'>          return</span><span><br /><span class='ace_line'><span class='ace_text'>            for $handler in s:handler(&quot;message&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>            return $handler($message/text());</span><span><br /><span class='ace_line'><span class='ace_text'>          </span><span><br /><span class='ace_line'><span class='ace_text'>          case $s:event</span><span><br /><span class='ace_line'><span class='ace_text'>          return</span><span><br /><span class='ace_line'><span class='ace_text'>            let $event-name := json:parse($message/text())/j:pair[@name=&quot;name&quot;]/text()</span><span><br /><span class='ace_line'><span class='ace_text'>            for $handler in s:handler($event-name)</span><span><br /><span class='ace_line'><span class='ace_text'>            return $handler($message/text());</span><span><br /><span class='ace_line'><span class='ace_text'>            </span><span><br /><span class='ace_line'><span class='ace_text'>        default return ();</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>      if(req:method-get()) then { </span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>        s:heartbeat();</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>        variable $messages := s:close();</span><span><br /><span class='ace_line'><span class='ace_text'>        variable $timeout  := 0;</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>        if(true()) then</span><span><br /><span class='ace_line'><span class='ace_text'>          (: We have a padding of 3/4 the connection timeout :)</span><span><br /><span class='ace_line'><span class='ace_text'>          while(empty($messages) and $timeout lt ($s:connection-timeout * 3 div 4)) {</span><span><br /><span class='ace_line'><span class='ace_text'>            sleep:millis(50);</span><span><br /><span class='ace_line'><span class='ace_text'>            $messages := s:close();</span><span><br /><span class='ace_line'><span class='ace_text'>            $timeout := $timeout + 0.05;</span><span><br /><span class='ace_line'><span class='ace_text'>          }</span><span><br /><span class='ace_line'><span class='ace_text'>        else();</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>        if(empty($messages)) then</span><span><br /><span class='ace_line'><span class='ace_text'>          &quot;8::&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>        else</span><span><br /><span class='ace_line'><span class='ace_text'>          $messages</span><span><br /><span class='ace_line'><span class='ace_text'>          </span><span><br /><span class='ace_line'><span class='ace_text'>      } else {</span><span><br /><span class='ace_line'><span class='ace_text'>        &quot;1&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>      }</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>  } catch s:handshake {</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      $err:description</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:connect()</span><span><br /><span class='ace_line'><span class='ace_text'>as empty-sequence()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  $s:session-id := random:uuid();</span><span><br /><span class='ace_line'><span class='ace_text'>  variable $client := idx:probe-index-point-value($s:client, $s:session-id);</span><span><br /><span class='ace_line'><span class='ace_text'>  if(empty($client)) then </span><span><br /><span class='ace_line'><span class='ace_text'>    db:insert-nodes($s:clients, &lt;client id=&quot;{$s:session-id}&quot; last-seen=&quot;{date:current-dateTime()}&quot; /&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>  else</span><span><br /><span class='ace_line'><span class='ace_text'>    error();</span><span><br /><span class='ace_line'><span class='ace_text'>  s:send-impl(&quot;1::&quot;);</span><span><br /><span class='ace_line'><span class='ace_text'>  for $handler in s:handler(&quot;connect&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>  return $handler($s:session-id);</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private %an:sequential function s:close()</span><span><br /><span class='ace_line'><span class='ace_text'>as xs:string?</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  store:flush();</span><span><br /><span class='ace_line'><span class='ace_text'>  variable $client := idx:probe-index-point-value($s:client, $s:session-id);</span><span><br /><span class='ace_line'><span class='ace_text'>  variable $messages := (</span><span><br /><span class='ace_line'><span class='ace_text'>    for $message in idx:probe-index-point-value($s:message, $s:session-id)</span><span><br /><span class='ace_line'><span class='ace_text'>    let $datetime := xs:dateTime($message/@datetime)</span><span><br /><span class='ace_line'><span class='ace_text'>    order by $datetime ascending</span><span><br /><span class='ace_line'><span class='ace_text'>    return $message);</span><span><br /><span class='ace_line'><span class='ace_text'>  db:delete-nodes($messages);</span><span><br /><span class='ace_line'><span class='ace_text'>  if(count($messages) = 1) then {</span><span><br /><span class='ace_line'><span class='ace_text'>    $messages/text()</span><span><br /><span class='ace_line'><span class='ace_text'>  } else if(empty($messages)) then {</span><span><br /><span class='ace_line'><span class='ace_text'>    ()</span><span><br /><span class='ace_line'><span class='ace_text'>  } else {</span><span><br /><span class='ace_line'><span class='ace_text'>    string-join(</span><span><br /><span class='ace_line'><span class='ace_text'>      for $message in $messages</span><span><br /><span class='ace_line'><span class='ace_text'>      return</span><span><br /><span class='ace_line'><span class='ace_text'>        &quot;&amp;#65533;&quot; || string-length($message/text()) || &quot;&amp;#65533;&quot; || $message/text()</span><span><br /><span class='ace_line'><span class='ace_text'>      , &quot;&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>   }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private %an:sequential function s:disconnect()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  db:delete-nodes(idx:probe-index-point-value($s:client, $s:session-id));</span><span><br /><span class='ace_line'><span class='ace_text'>  for $handler in s:handler(&quot;disconnect&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>  return $handler($s:session-id);</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private %an:sequential function s:heartbeat()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  for $disconnected in db:collection($s:clients)[(date:current-dateTime() - xs:dateTime(@last-seen)) gt xs:dayTimeDuration(&quot;PT&quot; || $s:heartbeat-timeout || &quot;S&quot;)]</span><span><br /><span class='ace_line'><span class='ace_text'>  return {</span><span><br /><span class='ace_line'><span class='ace_text'>    variable $id := string($disconnected/@id);</span><span><br /><span class='ace_line'><span class='ace_text'>    db:delete-nodes($disconnected);</span><span><br /><span class='ace_line'><span class='ace_text'>    for $handler in s:handler(&quot;disconnect&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>    return $handler($id);</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  variable $client := idx:probe-index-point-value($s:client, $s:session-id);</span><span><br /><span class='ace_line'><span class='ace_text'>  if(empty($client)) then {</span><span><br /><span class='ace_line'><span class='ace_text'>     for $handler in s:handler(&quot;disconnect&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>     return $handler($s:session-id); </span><span><br /><span class='ace_line'><span class='ace_text'>  } else {</span><span><br /><span class='ace_line'><span class='ace_text'>    replace value of node $client/@last-seen with date:current-dateTime();</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:broadcast($event-name as xs:string, $data as xs:string)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  s:emit($event-name, $data, true())</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:emit($event-name as xs:string, $data as xs:string)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  s:emit($event-name, $data, false())</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:emit($event-name as xs:string, $data as xs:string, $broadcast as xs:boolean)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  s:send-impl(&quot;5:::&quot; || '{&quot;name&quot;:' || ' &quot;' || $event-name || '&quot;, &quot;args&quot;: [' || $data || &quot;]}&quot;, $broadcast)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:send-impl($message as xs:string)</span><span><br /><span class='ace_line'><span class='ace_text'>as empty-sequence()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  s:send-impl($message, false())</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private %an:sequential function s:send-impl($message as xs:string, $broadcast as xs:boolean)</span><span><br /><span class='ace_line'><span class='ace_text'>as empty-sequence()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  for $session-id in (if($broadcast) then db:collection($s:clients)/@id/string(.) else $s:session-id)</span><span><br /><span class='ace_line'><span class='ace_text'>  return</span><span><br /><span class='ace_line'><span class='ace_text'>    db:insert-nodes($s:messages, </span><span><br /><span class='ace_line'><span class='ace_text'>                    &lt;message datetime=&quot;{date:current-dateTime()}&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>                             session-id=&quot;{$session-id}&quot;&gt;{$message}&lt;/message&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private %an:sequential function s:handshake()</span><span><br /><span class='ace_line'><span class='ace_text'>{ </span><span><br /><span class='ace_line'><span class='ace_text'>  res:set-content-type(&quot;text/plain&quot;);</span><span><br /><span class='ace_line'><span class='ace_text'>  variable $segments := tokenize(req:path(), &quot;/&quot;)[. != &quot;&quot;];</span><span><br /><span class='ace_line'><span class='ace_text'>  $s:transport := $segments[3 + 1];</span><span><br /><span class='ace_line'><span class='ace_text'>  $s:session-id := $segments[4 + 1];</span><span><br /><span class='ace_line'><span class='ace_text'>  if($s:transport != $s:supported-transports) then</span><span><br /><span class='ace_line'><span class='ace_text'>    error($res:service-unavailable);</span><span><br /><span class='ace_line'><span class='ace_text'>  else</span><span><br /><span class='ace_line'><span class='ace_text'>    ();</span><span><br /><span class='ace_line'><span class='ace_text'>  (: If the transport is empty, it's an handshake :)</span><span><br /><span class='ace_line'><span class='ace_text'>  if(empty($s:transport)) then {</span><span><br /><span class='ace_line'><span class='ace_text'>    s:connect();</span><span><br /><span class='ace_line'><span class='ace_text'>    error($s:handshake, $s:session-id || &quot;:&quot; || $s:heartbeat-timeout || &quot;:&quot; || $s:connection-timeout || &quot;:&quot; || string-join($s:supported-transports, &quot;,&quot;));</span><span><br /><span class='ace_line'><span class='ace_text'>  } else{}</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private function s:messages()</span><span><br /><span class='ace_line'><span class='ace_text'>as element(message)*</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  let $payload := if(req:method-get()) then () else req:text-content()</span><span><br /><span class='ace_line'><span class='ace_text'>  return</span><span><br /><span class='ace_line'><span class='ace_text'>    if(empty($payload)) then</span><span><br /><span class='ace_line'><span class='ace_text'>      ()</span><span><br /><span class='ace_line'><span class='ace_text'>    else if(not(starts-with($payload, &quot;&amp;#65533;&quot;))) then</span><span><br /><span class='ace_line'><span class='ace_text'>      s:parse-message($payload)</span><span><br /><span class='ace_line'><span class='ace_text'>    else</span><span><br /><span class='ace_line'><span class='ace_text'>      let $tokens := tokenize($payload, &quot;&amp;#65533;(\d)+&amp;#65533;&quot;)[. != &quot;&quot;]</span><span><br /><span class='ace_line'><span class='ace_text'>      for $token in $tokens</span><span><br /><span class='ace_line'><span class='ace_text'>      return s:parse-message($token)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private function s:parse-message($payload as xs:string)</span><span><br /><span class='ace_line'><span class='ace_text'>as element(message)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  let $segments := tokenize($payload, &quot;:&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>  let $type := number($segments[1])</span><span><br /><span class='ace_line'><span class='ace_text'>  let $id := $segments[2]</span><span><br /><span class='ace_line'><span class='ace_text'>  let $endpoint := $segments[3]</span><span><br /><span class='ace_line'><span class='ace_text'>  let $data := string-join(subsequence($segments, 4), &quot;:&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>  return</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;message id=&quot;{$id}&quot; endpoint=&quot;{$endpoint}&quot; type=&quot;{$type}&quot;&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      $data</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;/message&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private function s:serialize-message($message as element(message))</span><span><br /><span class='ace_line'><span class='ace_text'>as xs:string</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  let $type := string($message/@type)</span><span><br /><span class='ace_line'><span class='ace_text'>  let $id   := string($message/@id)</span><span><br /><span class='ace_line'><span class='ace_text'>  let $endpoint := string($message/@endpoint)</span><span><br /><span class='ace_line'><span class='ace_text'>  let $data := $message/text()</span><span><br /><span class='ace_line'><span class='ace_text'>  return</span><span><br /><span class='ace_line'><span class='ace_text'>    $type || &quot;:&quot; || $id || &quot;:&quot; || $endpoint || &quot;:&quot; || $data</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>(:</span><span><br /><span class='ace_line'><span class='ace_text'> : Copyright 2010 28msec Inc.</span><span><br /><span class='ace_line'><span class='ace_text'> :)</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> guestbook = </span><span class='ace_string'>&quot;http://www.28msec.com/templates/guestbook/guestbook&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> http = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/http&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> xqddf = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/xqddf&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>collection</span><span class='ace_text'> guestbook:entries </span><span class='ace_keyword'>as</span><span class='ace_text'> node()*;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;guestbook:entries&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> guestbook:add()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>http:set-header</span><span class='ace_text'>(</span><span class='ace_string'>&quot;Cache-Control&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;no-cache&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>xqddf:insert-nodes</span><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'>,</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>entry</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>author</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>http:get-parameters</span><span class='ace_text'>(</span><span class='ace_string'>&quot;author&quot;</span><span class='ace_text'>)}</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>date</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>fn:current-date</span><span class='ace_text'>()}</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>time</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>fn:current-time</span><span class='ace_text'>()}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>      {</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span class='ace_support ace_function'>http:get-parameters</span><span class='ace_text'>(</span><span class='ace_string'>&quot;text&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>      }</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;/</span><span class='ace_meta ace_tag'>entry</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>  );</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_support ace_function'>guestbook:list</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> guestbook:list() {</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>http:set-header</span><span class='ace_text'>(</span><span class='ace_string'>&quot;Cache-Control&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;no-cache&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$entries</span><span class='ace_text'> := </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$e</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>xqddf:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>                  </span><span class='ace_keyword'>order</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_support ace_function'>xs:date</span><span class='ace_text'>(</span><span class='ace_variable'>$e</span><span class='ace_text'>/@date), </span><span class='ace_support ace_function'>xs:time</span><span class='ace_text'>(</span><span class='ace_variable'>$e</span><span class='ace_text'>/@time)</span><span><br /><span class='ace_line'><span class='ace_text'>                  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_variable'>$e</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> := </span><span class='ace_support ace_function'>fn:count</span><span class='ace_text'>(</span><span class='ace_variable'>$entries</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>if</span><span class='ace_text'>(</span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_constant'>0</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>then</span><span class='ace_text'>    </span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>entry</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;No entries, yet.&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$entry</span><span class='ace_text'> </span><span class='ace_keyword'>at</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_variable'>$entries</span><span class='ace_text'>[</span><span class='ace_support ace_function'>position</span><span class='ace_text'>() </span><span class='ace_keyword'>gt</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> </span><span class='ace_constant'>5</span><span class='ace_text'>]</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$numbering</span><span class='ace_text'> := </span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword'>lt</span><span class='ace_text'> </span><span class='ace_constant'>5</span><span class='ace_text'>) </span><span class='ace_keyword'>then</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'> </span><span class='ace_keyword'>else</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> ( </span><span class='ace_constant'>5</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'>) </span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>return</span><span class='ace_text'> &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>entry</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>header</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$entry</span><span class='ace_text'>/@author)}&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>content</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$entry</span><span class='ace_text'>/text()}&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>datetime</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$entry</span><span class='ace_text'>/@datetime)}&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>               &lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>import module namespace raytracer=&quot;http://www.xqsharp.com/raytracer&quot; at &quot;raytracer.xqlib&quot;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> scene=</span><span class='ace_string'>&quot;http://www.xqsharp.com/raytracer/scene&quot;</span><span class='ace_text'> </span><span class='ace_keyword'>at</span><span class='ace_text'> </span><span class='ace_string'>&quot;scene.xqlib&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> serialization=</span><span class='ace_string'>&quot;http://www.xqsharp.com/serialization&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>option</span><span class='ace_text'> serialization:method </span><span class='ace_string'>&quot;text&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>option</span><span class='ace_text'> serialization:encoding </span><span class='ace_string'>&quot;us-ascii&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$width</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>10</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$height</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>10</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$scene</span><span class='ace_text'> := </span><span class='ace_support ace_function'>scene:prepare-scene</span><span class='ace_text'>(</span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;scene.xml&quot;</span><span class='ace_text'>)/scene);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>string-join</span><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_text'>  (</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_comment'>(: Magic number identifying the file as a &quot;plain&quot; ppm file :)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>&quot;P3&quot;</span><span class='ace_text'>,</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_comment'>(: width and height :)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_support ace_function'>string-join</span><span class='ace_text'>((</span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$width</span><span class='ace_text'>), </span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$height</span><span class='ace_text'>)), </span><span class='ace_string'>&quot; &quot;</span><span class='ace_text'>),</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_comment'>(: Maximum color value :)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>&quot;255&quot;</span><span class='ace_text'>,</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_comment'>(:</span><span><br /><span class='ace_line'><span class='ace_comment'>     : Now the pixel data.  We take each pixel in the image, and recenter it, so that the</span><span><br /><span class='ace_line'><span class='ace_comment'>     : y co-ordinate ($y-recentered) ranges from -0.5 at the bottom of the image, to 0.5 </span><span><br /><span class='ace_line'><span class='ace_comment'>     : at the top of the image.</span><span><br /><span class='ace_line'><span class='ace_comment'>     :        </span><span><br /><span class='ace_line'><span class='ace_comment'>     : The aspect ratio is used to &quot;stretch&quot; the range of x-coordinate values to stop the</span><span><br /><span class='ace_line'><span class='ace_comment'>     : image from being skewed.</span><span><br /><span class='ace_line'><span class='ace_comment'>     :)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$aspect-ratio</span><span class='ace_text'> := </span><span class='ace_variable'>$width</span><span class='ace_text'> </span><span class='ace_keyword'>div</span><span class='ace_text'> </span><span class='ace_variable'>$height</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_variable'>$height</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$y-recentered</span><span class='ace_text'> := ((</span><span class='ace_keyword ace_operator'>-</span><span class='ace_variable'>$y</span><span class='ace_text'> </span><span class='ace_keyword'>div</span><span class='ace_text'> </span><span class='ace_variable'>$height</span><span class='ace_text'>) </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>0.5</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_variable'>$width</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$x-recentered</span><span class='ace_text'> := ((</span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>div</span><span class='ace_text'> </span><span class='ace_variable'>$width</span><span class='ace_text'>) </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> </span><span class='ace_constant'>0.5</span><span class='ace_text'>) </span><span class='ace_keyword ace_operator'>*</span><span class='ace_text'> </span><span class='ace_variable'>$aspect-ratio</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_comment'>(: plot-pixel returns us the rgb values of the color of this pixel.  We convert these</span><span><br /><span class='ace_line'><span class='ace_comment'>         to an integer value in the range [0, 255], and output them. :)</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>string-join</span><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$channel</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>raytracer:plot-pixel</span><span class='ace_text'>(</span><span class='ace_variable'>$scene</span><span class='ace_text'>, </span><span class='ace_variable'>$x-recentered</span><span class='ace_text'>, </span><span class='ace_variable'>$y-recentered</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_support ace_function'>floor</span><span class='ace_text'>(</span><span class='ace_variable'>$channel</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>*</span><span class='ace_text'> </span><span class='ace_constant'>255</span><span class='ace_text'>)),</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span class='ace_string'>&quot; &quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  ),</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>), </span><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>'FitnessCenter.xml'</span><span class='ace_text'>)//*</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_keyword'>rename</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> </span><span class='ace_support ace_function'>QName</span><span class='ace_text'>(</span><span class='ace_string'>'http://www.gym.com'</span><span class='ace_text'>, </span><span class='ace_support ace_function'>concat</span><span class='ace_text'>(</span><span class='ace_string'>'gym:'</span><span class='ace_text'>, </span><span class='ace_support ace_function'>local-name</span><span class='ace_text'>(</span><span class='ace_variable'>$i</span><span class='ace_text'>)));</span><span><br /><span class='ace_line'><span class='ace_support ace_function'>fn:doc</span><span class='ace_text'>(</span><span class='ace_string'>'FitnessCenter.xml'</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> xqd = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/xqdoc&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>schema</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> xqds = </span><span class='ace_string'>&quot;http://www.xqdoc.org/1.0&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> err = </span><span class='ace_string'>&quot;http://www.w3.org/2005/xqt-errors&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>try</span><span class='ace_text'> {</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>xqd:xqdoc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;gdata_error.xqlib&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>} catch *  {</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$err:code</span><span class='ace_text'>, </span><span class='ace_variable'>$err:description</span><span><br /><span class='ace_line'><span class='ace_text'>},</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>try</span><span class='ace_text'> {</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>xqd:xqdoc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;gdata_error.xqlib&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>} catch *  {</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$err:code</span><span class='ace_text'>, </span><span class='ace_variable'>$err:description</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>break</span><span class='ace_text'> </span><span class='ace_keyword'>loop</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;{</span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span class='ace_constant'>1</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>element</span><span class='ace_text'> book {</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>attribute</span><span class='ace_text'> isbn {</span><span class='ace_string'>&quot;isbn-0060229357&quot;</span><span class='ace_text'> },</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>element</span><span class='ace_text'> title { </span><span class='ace_constant'>1</span><span class='ace_text'>; </span><span class='ace_string'>&quot;Harold and the Purple Crayon&quot;</span><span class='ace_text'> }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>element</span><span class='ace_text'> book {</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>attribute</span><span class='ace_text'> isbn { </span><span class='ace_constant'>1</span><span class='ace_text'>; </span><span class='ace_string'>&quot;isbn-0060229357&quot;</span><span class='ace_text'> },</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>element</span><span class='ace_text'> title { </span><span class='ace_constant'>1</span><span class='ace_text'>; </span><span class='ace_string'>&quot;Harold and the Purple Crayon&quot;</span><span class='ace_text'> }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>import module namespace r = &quot;http://www.zorba-xquery.com/modules/random&quot;;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_comment'>(: test call to a nondeterministic function in an element constructor :)</span><span><br /><span class='ace_line'><span class='ace_keyword'>element</span><span class='ace_text'> book {</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>element</span><span class='ace_text'> title { </span><span class='ace_support ace_function'>r:random</span><span class='ace_text'>() ; </span><span class='ace_string'>&quot;Harold and the Purple Crayon&quot;</span><span class='ace_text'> }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>import module namespace ddl = &quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_comment'>(: test call to a side-effecting function in an element constructor :)</span><span><br /><span class='ace_line'><span class='ace_keyword'>element</span><span class='ace_text'> book {</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>element</span><span class='ace_text'> title { </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_support ace_function'>fn:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;foo:bar&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;blub&quot;</span><span class='ace_text'>)) ; </span><span class='ace_string'>&quot;Harold and the Purple Crayon&quot;</span><span class='ace_text'> },</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>element</span><span class='ace_text'> blub { </span><span class='ace_support ace_function'>dml:apply-insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_support ace_function'>fn:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;foo:bar&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;blub&quot;</span><span class='ace_text'>), &lt;</span><span class='ace_meta ace_tag'>blub2</span><span class='ace_text'>/&gt;) }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> op = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/options/features&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>option</span><span class='ace_text'> op:disable </span><span class='ace_string'>&quot;scripting&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>{ }</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;{ </span><span class='ace_constant'>1</span><span class='ace_text'>; }&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;</span><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;{ </span><span class='ace_constant'>1</span><span class='ace_text'>; () }&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;</span><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;content{ </span><span class='ace_constant'>1</span><span class='ace_text'>; }content&lt;/</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;</span><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;content{ </span><span class='ace_constant'>1</span><span class='ace_text'>; () }content&lt;/</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;</span><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;content{ }content&lt;/</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;</span><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:magic-trick() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> (</span><span class='ace_string'>&quot;magician's hat:&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;rabbit&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> (</span><span class='ace_string'>&quot;dead code&quot;</span><span class='ace_text'>); </span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:professional-magician() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$res</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:magic-trick</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_variable'>$res</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:professional-magician</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_constant'>1</span><span class='ace_text'>, exit </span><span class='ace_support ace_function'>returning</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:searchFor(</span><span class='ace_variable'>$obj</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string) </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$obj</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:trick(</span><span class='ace_variable'>$object</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string) </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$s</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:searchFor</span><span class='ace_text'>(</span><span class='ace_variable'>$object</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> (</span><span class='ace_string'>&quot;hat:&quot;</span><span class='ace_text'>, </span><span class='ace_variable'>$s</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_string'>&quot;THIS IS THE SECRET&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:magician() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$s</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:trick</span><span class='ace_text'>(</span><span class='ace_string'>&quot;rabbit&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_variable'>$s</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:magician</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:searchFor(</span><span class='ace_variable'>$obj</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string) </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$obj</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:trick(</span><span class='ace_variable'>$object</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string) </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$s</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:searchFor</span><span class='ace_text'>(</span><span class='ace_variable'>$object</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_variable'>$s</span><span class='ace_text'>) </span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_string'>&quot;hat&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>else</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:trick</span><span class='ace_text'>(</span><span class='ace_string'>&quot;foo&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:cook() </span><span class='ace_keyword'>as</span><span class='ace_text'> element(soup)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_string'>&quot;garbage&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:cook</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test3()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test3</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_constant'>0</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>, </span><span class='ace_constant'>2</span><span class='ace_text'>, </span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> := { </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'>; }</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_constant'>0</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> := { </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>; }</span><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>, </span><span class='ace_constant'>2</span><span class='ace_text'>, </span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test1()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test2()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>cc1</span><span class='ace_text'>/&gt;&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;, &lt;</span><span class='ace_meta ace_tag'>e</span><span class='ace_text'>/&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>/&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$k</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>4</span><span class='ace_text'>, </span><span class='ace_constant'>5</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>local:test2</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>, </span><span class='ace_constant'>2</span><span class='ace_text'>, </span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span class='ace_text'> &lt;</span><span class='ace_meta ace_tag'>res</span><span class='ace_text'>&gt;{</span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_variable'>$i</span><span class='ace_text'>/*) </span><span class='ace_keyword'>then</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'>/* </span><span class='ace_keyword'>else</span><span class='ace_text'> </span><span class='ace_support ace_function'>local-name-from-QName</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)}&lt;/</span><span class='ace_meta ace_tag'>res</span><span class='ace_text'>&gt; </span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>,</span><span class='ace_constant'>2</span><span class='ace_text'>,</span><span class='ace_constant'>3</span><span class='ace_text'>,</span><span class='ace_constant'>4</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>switch</span><span class='ace_text'> (</span><span class='ace_variable'>$mode</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>case</span><span class='ace_text'> </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_support ace_function'>fn:trace</span><span class='ace_text'>(</span><span class='ace_variable'>$mode</span><span class='ace_text'>, </span><span class='ace_string'>&quot;option mode&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;value&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>'option'</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>case</span><span class='ace_text'> </span><span class='ace_string'>&quot;value&quot;</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_support ace_function'>fn:trace</span><span class='ace_text'>(</span><span class='ace_variable'>$mode</span><span class='ace_text'>, </span><span class='ace_string'>&quot;value mode&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>'value'</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>default</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_string'>&quot;default&quot;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>,</span><span class='ace_constant'>2</span><span class='ace_text'>,</span><span class='ace_constant'>3</span><span class='ace_text'>,</span><span class='ace_constant'>4</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span class='ace_text'> :=</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>switch</span><span class='ace_text'> (</span><span class='ace_variable'>$mode</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>case</span><span class='ace_text'> </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;value&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>&quot;option&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>case</span><span class='ace_text'> </span><span class='ace_string'>&quot;value&quot;</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>&quot;value&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>default</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_string'>&quot;default&quot;</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>  &lt;</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$i</span><span class='ace_text'>, </span><span class='ace_variable'>$j</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test3()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>d</span><span class='ace_text'>/&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$item</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_variable'>$item</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>fn:empty</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test3</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;1&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;2&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_constant'>1</span><span class='ace_text'>]/c</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_constant'>1</span><span class='ace_text'>]);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-first</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$x</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test3()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>d</span><span class='ace_text'>/&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>,</span><span class='ace_constant'>2</span><span class='ace_text'>,</span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$item</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_variable'>$item</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>fn:empty</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test3</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;1&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;2&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_constant'>1</span><span class='ace_text'>]/c</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_support ace_function'>count</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)) </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_variable'>$i</span><span class='ace_text'>]);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-first</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$x</span><span class='ace_text'>}-{</span><span class='ace_variable'>$i</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$x</span><span class='ace_text'>}-{</span><span class='ace_variable'>$i</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;1&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;2&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_constant'>1</span><span class='ace_text'>]/c</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_support ace_function'>count</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)) </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>order</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>descending</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_variable'>$i</span><span class='ace_text'>]);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-first</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$x</span><span class='ace_text'>}-{</span><span class='ace_variable'>$i</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$x</span><span class='ace_text'>}-{</span><span class='ace_variable'>$i</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$gid</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>0</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>{ </span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;sales-records.xml&quot;</span><span class='ace_text'>)/*/record</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$state</span><span class='ace_text'> := </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;stores.xml&quot;</span><span class='ace_text'>)/*/store[store-number </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'>/store-number]/state</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$category</span><span class='ace_text'> := </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;products.xml&quot;</span><span class='ace_text'>)/*/product[name </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'>/product-name]/category</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>group</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_variable'>$state</span><span class='ace_text'>, </span><span class='ace_variable'>$category</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>order</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_variable'>$state</span><span class='ace_text'>, </span><span class='ace_variable'>$category</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$gid</span><span class='ace_text'> := </span><span class='ace_variable'>$gid</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>    &lt;</span><span class='ace_meta ace_tag'>group</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>id</span><span class='ace_text'> = </span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$gid</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>      {</span><span class='ace_variable'>$state</span><span class='ace_text'>, </span><span class='ace_variable'>$category</span><span class='ace_text'>}</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>total-qty</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>sum</span><span class='ace_text'>(</span><span class='ace_variable'>$sales</span><span class='ace_text'>/qty)}&lt;/</span><span class='ace_meta ace_tag'>total-qty</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;/</span><span class='ace_meta ace_tag'>group</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;/</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$gid</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>0</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>{ </span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;sales-records.xml&quot;</span><span class='ace_text'>)/*/record</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$state</span><span class='ace_text'> := </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;stores.xml&quot;</span><span class='ace_text'>)/*/store[store-number </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'>/store-number]/state</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$category</span><span class='ace_text'> := </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;products.xml&quot;</span><span class='ace_text'>)/*/product[name </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'>/product-name]/category</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>group</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_variable'>$state</span><span class='ace_text'>, </span><span class='ace_variable'>$category</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$gid</span><span class='ace_text'> := </span><span class='ace_variable'>$gid</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>    &lt;</span><span class='ace_meta ace_tag'>group</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>id</span><span class='ace_text'> = </span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$gid</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>      {</span><span class='ace_variable'>$state</span><span class='ace_text'>, </span><span class='ace_variable'>$category</span><span class='ace_text'>}</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>total-qty</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>sum</span><span class='ace_text'>(</span><span class='ace_variable'>$sales</span><span class='ace_text'>/qty)}&lt;/</span><span class='ace_meta ace_tag'>total-qty</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;/</span><span class='ace_meta ace_tag'>group</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;/</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$seq</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string* := ();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>,</span><span class='ace_constant'>2</span><span class='ace_text'>,</span><span class='ace_constant'>3</span><span class='ace_text'>,</span><span class='ace_constant'>4</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span class='ace_text'>  </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_support ace_function'>empty</span><span class='ace_text'>(</span><span class='ace_variable'>$seq</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$seq</span><span class='ace_text'>:=(</span><span class='ace_variable'>$seq</span><span class='ace_text'>, </span><span class='ace_string'>&quot;empty&quot;</span><span class='ace_text'>, </span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$x</span><span class='ace_text'>));</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$seq</span><span class='ace_text'>:=(</span><span class='ace_variable'>$seq</span><span class='ace_text'>, </span><span class='ace_string'>&quot;full&quot;</span><span class='ace_text'>, </span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$x</span><span class='ace_text'>));</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_variable'>$seq</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>import module namespace ddl = &quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;1&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;2&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>where</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>&gt;</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>2</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$c</span><span class='ace_text'> := </span><span class='ace_support ace_function'>count</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)) </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_variable'>$i</span><span class='ace_text'>]);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-first</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$c</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$c</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_comment'>(:</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>i , j , c</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>2 , 1 , 3 --&gt; &lt;x i=2 3&gt; &lt;a&gt; &lt;x i=2 3&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>2 , 2 , 4 --&gt; &lt;x i=2 4&gt; &lt;x i=2 3&gt; &lt;x i=2 3&gt; &lt;x i=2 4&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>3 , 1 , 3 --&gt; &lt;x i=3 3&gt;   &lt;x i=2 4&gt; &lt;x i=2 3&gt; &lt;x i=2 4&gt;   &lt;x i=3 3&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>3 , 2 , 4 --&gt; &lt;x i=3 4&gt;   &lt;x i=3 3&gt; &lt;x i=2 4&gt; &lt;x i=2 4&gt; &lt;x i=3 3&gt;   &lt;x i=3 4&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'>:)</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>import module namespace ddl = &quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;1&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;2&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>where</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>&gt;</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>2</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$c</span><span class='ace_text'> := </span><span class='ace_support ace_function'>count</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)) </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>order</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_variable'>$c</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_variable'>$i</span><span class='ace_text'>]);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-first</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$c</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$c</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_comment'>(:</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>i , j , c</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>2 , 1 , 3 --&gt; &lt;x i=2 3&gt; &lt;a&gt; &lt;x i=2 3&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>3 , 1 , 3 --&gt; &lt;x i=3 3&gt;   &lt;x i=2 3&gt; &lt;a&gt;   &lt;x i=3 3&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>2 , 2 , 4 --&gt; &lt;x i=2 4&gt;   &lt;x i=3 3&gt; &lt;a&gt; &lt;x i=3 3&gt;    &lt;x i=2 4&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>3 , 2 , 4 --&gt; &lt;x i=3 4&gt;   &lt;x i=2 4&gt; &lt;x i=3 3&gt; &lt;x i=3 3&gt; &lt;x i=2 4&gt;    &lt;x i=3 4&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'>:)</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> := </span><span class='ace_constant'>10</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_constant'>9</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>&gt;</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.my-annotation.com/&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> op = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/options/warnings&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>option</span><span class='ace_text'> op:disable </span><span class='ace_string'>&quot;all&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$local:foo1</span><span class='ace_text'> := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$local:foo2</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$local:foo3</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>2</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo4</span><span class='ace_text'> := </span><span class='ace_string'>&quot;foo&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>%ann:foo </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$local:foo5</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>%ann:foo1 %ann:foo2 </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$local:foo6</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>(</span><span class='ace_variable'>$local:foo1</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo2</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo3</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo4</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo5</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo6</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:nonsequential %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_constant'>1</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:nonsequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$s</span><span class='ace_text'> := </span><span class='ace_support ace_function'>fn:max</span><span class='ace_text'>((</span><span class='ace_constant'>1</span><span class='ace_text'>,</span><span class='ace_constant'>2</span><span class='ace_text'>,</span><span class='ace_constant'>3</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> (</span><span class='ace_string'>&quot;max:&quot;</span><span class='ace_text'>, </span><span class='ace_variable'>$s</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_string'>&quot;THIS IS THE SECRET&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> map = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/data-structures/unordered-map&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:nonsequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>map:create</span><span class='ace_text'>(</span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;local:mymap&quot;</span><span class='ace_text'>), </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;xs:integer&quot;</span><span class='ace_text'>));</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>updating</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test3()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    (</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>delete</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'>,</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span class='ace_text'>    )</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test3</span><span class='ace_text'>(),</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_string'>&quot;,</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> xqsx = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/zorba/scripting&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>updating</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test3()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    (</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_variable'>$x</span><span class='ace_text'>),</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span class='ace_text'>    )</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_support ace_function'>xqsx:apply</span><span class='ace_text'>(</span><span class='ace_support ace_function'>local:test3</span><span class='ace_text'>()),</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_string'>&quot;,</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$sequence</span><span class='ace_text'> := (</span><span class='ace_constant'>65</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>90</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_variable'>$var</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:bar()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$rand</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$sequence</span><span class='ace_text'>[</span><span class='ace_variable'>$rand</span><span class='ace_text'>]</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:bar</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$sequence</span><span class='ace_text'> := (</span><span class='ace_constant'>65</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>90</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_variable'>$var</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:bar()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$rand</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$sequence</span><span class='ace_text'>[</span><span class='ace_variable'>$rand</span><span class='ace_text'>]</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:bar</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$sequence</span><span class='ace_text'> := (</span><span class='ace_constant'>65</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>90</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_variable'>$var</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:bar()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$rand</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$sequence</span><span class='ace_text'>[</span><span class='ace_variable'>$rand</span><span class='ace_text'>]</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:bar</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:handle()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>local:handle-method</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>if</span><span class='ace_text'>(</span><span class='ace_support ace_function'>true</span><span class='ace_text'>()) </span><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>    ()</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>else</span><span class='ace_text'> ()</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>function</span><span class='ace_text'> local:handle-method()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>true</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:handle</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$cnt</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$map</span><span class='ace_text'> := &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>b1</span><span class='ace_text'>/&gt;&lt;</span><span class='ace_meta ace_tag'>b2</span><span class='ace_text'>/&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$repl</span><span class='ace_text'> := &lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>/&gt;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$result</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> node()* := ();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>while</span><span class='ace_text'> (</span><span class='ace_variable'>$cnt</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>&lt;</span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$cnt</span><span class='ace_text'> := </span><span class='ace_variable'>$cnt</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$result</span><span class='ace_text'> := (</span><span class='ace_variable'>$result</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>              ,</span><span><br /><span class='ace_line'><span class='ace_text'>              </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$rec</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_variable'>$map</span><span class='ace_text'>/*</span><span><br /><span class='ace_line'><span class='ace_text'>              </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>              </span><span class='ace_keyword'>if</span><span class='ace_text'> ( </span><span class='ace_variable'>$repl</span><span class='ace_text'>[</span><span class='ace_support ace_function'>name</span><span class='ace_text'>() </span><span class='ace_keyword'>eq</span><span class='ace_text'> </span><span class='ace_support ace_function'>name</span><span class='ace_text'>(</span><span class='ace_variable'>$rec</span><span class='ace_text'>)] )</span><span><br /><span class='ace_line'><span class='ace_text'>              </span><span class='ace_keyword'>then</span><span class='ace_text'> ()</span><span><br /><span class='ace_line'><span class='ace_text'>              </span><span class='ace_keyword'>else</span><span class='ace_text'> </span><span class='ace_variable'>$rec</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_variable'>$result</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>updating</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt;;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>insert</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> &lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>/&gt; </span><span class='ace_keyword'>into</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> x =</span><span><br /><span class='ace_line'><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/data-structures/unordered-map&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_support ace_function'>fn:true</span><span class='ace_text'>())</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$req</span><span class='ace_text'> := &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt;;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$result</span><span class='ace_text'> := </span><span class='ace_support ace_function'>x:create</span><span class='ace_text'>(</span><span class='ace_support ace_function'>fn:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;http://www.zorba-xquery.com/map&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;first&quot;</span><span class='ace_text'>),</span><span><br /><span class='ace_line'><span class='ace_text'>                                 </span><span class='ace_support ace_function'>fn:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;http://www.w3.org/2001/XMLSchema&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;xs:integer&quot;</span><span class='ace_text'>));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$result</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>  ()</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$doc</span><span class='ace_text'> :=</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>root</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>n1</span><span class='ace_text'>/&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>n2</span><span class='ace_text'>/&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;/</span><span class='ace_meta ace_tag'>root</span><span class='ace_text'>&gt;;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:boo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo(</span><span class='ace_variable'>$nodes</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> node()*)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$n</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_variable'>$nodes</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_support ace_function'>count</span><span class='ace_text'>((</span><span class='ace_variable'>$n</span><span class='ace_text'>/following-sibling::*[</span><span class='ace_constant'>1</span><span class='ace_text'>])/*)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>(</span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$node</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_variable'>$doc</span><span class='ace_text'>/*</span><span><br /><span class='ace_line'><span class='ace_text'>          </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>          {</span><span><br /><span class='ace_line'><span class='ace_text'>            </span><span class='ace_keyword'>insert</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt; </span><span class='ace_keyword'>as</span><span class='ace_text'> </span><span class='ace_keyword'>first</span><span class='ace_text'> </span><span class='ace_keyword'>into</span><span class='ace_text'> </span><span class='ace_variable'>$node</span><span class='ace_text'>; </span><span><br /><span class='ace_line'><span class='ace_text'>            </span><span class='ace_variable'>$node</span><span><br /><span class='ace_line'><span class='ace_text'>          })</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>while</span><span class='ace_text'>(</span><span class='ace_support ace_function'>true</span><span class='ace_text'>()) </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>break</span><span class='ace_text'> </span><span class='ace_keyword'>loop</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> functx = </span><span class='ace_string'>&quot;http://www.functx.com/&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>functx:substring-before-last</span><span class='ace_text'>(</span><span class='ace_string'>'abc-def-ghi'</span><span class='ace_text'>, </span><span class='ace_string'>'-'</span><span class='ace_text'>)</span><span><br /></pre></body></html>