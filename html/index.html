<html><head><link media='all' rel='stylesheet'  href='main.css'></link><script type='text/javascript' src='require.js'></script><script type='text/javascript' src='jquery-1.7.2.js'></script><script type='text/javascript' src='main.js'></script><style type='text/css'>body { font-family: Monaco, Menlo, 'Ubuntu Mono', 'Droid Sans Mono', Consolas, monospace; font-size: 14px; }</style></head><body><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> a = </span><span class='ace_string'>&quot;http://www.28msec.com/xqdoc/lib/accounts&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> hash = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/cryptography/hash&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> session = </span><span class='ace_string'>&quot;http://www.28msec.com/xqdoc/lib/session&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>collection</span><span class='ace_text'> a:accounts </span><span class='ace_keyword'>as</span><span class='ace_text'> element(account);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$a:accounts</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'a:accounts'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private %automatic %an:automatic %an:unique %an:value-equality </span><span class='ace_keyword'>index</span><span class='ace_text'> a:account</span><span><br /><span class='ace_line'><span class='ace_keyword'>on</span><span class='ace_text'> </span><span class='ace_keyword'>nodes</span><span class='ace_text'> </span><span class='ace_support ace_function'>db:collection</span><span class='ace_text'>(</span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'a:accounts'</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_support ace_function'>xs:string</span><span class='ace_text'>(@username) </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$a:account</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'a:account'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$a:INVALID_USERNAME_OR_PASSWORD</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'a:INVALID_USERNAME_OR_PASSWORD'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$a:USERNAME_ALREADY_EXISTS</span><span class='ace_text'>      </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'a:USERNAME_ALREADY_EXISTS'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> a:create-account(</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$username</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string, </span><span class='ace_variable'>$password</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string, </span><span class='ace_variable'>$email</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string  </span><span><br /><span class='ace_line'><span class='ace_text'>) </span><span class='ace_keyword'>as</span><span class='ace_text'> </span><span class='ace_keyword'>empty-sequence</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$account</span><span class='ace_text'> := </span><span class='ace_support ace_function'>idx:probe-index-point-value</span><span class='ace_text'>(</span><span class='ace_variable'>$a:account</span><span class='ace_text'>, </span><span class='ace_variable'>$username</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_keyword'>if</span><span class='ace_text'>(</span><span class='ace_support ace_function'>exists</span><span class='ace_text'>(</span><span class='ace_variable'>$account</span><span class='ace_text'>)) </span><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>error</span><span class='ace_text'>(</span><span class='ace_variable'>$a:USERNAME_ALREADY_EXISTS</span><span class='ace_text'>, </span><span class='ace_string'>&quot;Username already exists: &quot;</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>||</span><span class='ace_text'> </span><span class='ace_variable'>$username</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>db:insert-nodes</span><span class='ace_text'>(</span><span class='ace_variable'>$a:accounts</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>account</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>username</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$username</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>                                            </span><span class='ace_meta ace_tag'>password</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>hash:sha1</span><span class='ace_text'>(</span><span class='ace_variable'>$password</span><span class='ace_text'>)}</span><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>                                            </span><span class='ace_meta ace_tag'>email</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$email</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'> /&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> a:login(</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$username</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string, </span><span class='ace_variable'>$password</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string?</span><span><br /><span class='ace_line'><span class='ace_text'>) </span><span class='ace_keyword'>as</span><span class='ace_text'> </span><span class='ace_keyword'>empty-sequence</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$account</span><span class='ace_text'>   := </span><span class='ace_support ace_function'>idx:probe-index-point-value</span><span class='ace_text'>(</span><span class='ace_variable'>$a:account</span><span class='ace_text'>, </span><span class='ace_variable'>$username</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$logged-in</span><span class='ace_text'> := ( </span><span><br /><span class='ace_line'><span class='ace_text'>                      </span><span class='ace_support ace_function'>exists</span><span class='ace_text'>(</span><span class='ace_variable'>$password</span><span class='ace_text'>) </span><span class='ace_keyword'>and</span><span><br /><span class='ace_line'><span class='ace_text'>                      </span><span class='ace_support ace_function'>hash:sha1</span><span class='ace_text'>(</span><span class='ace_variable'>$password</span><span class='ace_text'>) </span><span class='ace_keyword'>eq</span><span class='ace_text'> </span><span class='ace_variable'>$account</span><span class='ace_text'>/@password/</span><span class='ace_support ace_function'>string</span><span class='ace_text'>(.)</span><span><br /><span class='ace_line'><span class='ace_text'>                    )</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span class='ace_text'> {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>if</span><span class='ace_text'>(</span><span class='ace_variable'>$logged-in</span><span class='ace_text'>) </span><span class='ace_keyword'>then</span><span class='ace_text'> {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$session</span><span class='ace_text'> := </span><span class='ace_support ace_function'>session:get</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>a:upsert</span><span class='ace_text'>(</span><span class='ace_variable'>$session</span><span class='ace_text'>, </span><span class='ace_variable'>$session</span><span class='ace_text'>/@username, </span><span class='ace_variable'>$account</span><span class='ace_text'>/@username);</span><span><br /><span class='ace_line'><span class='ace_text'>    } </span><span class='ace_keyword'>else</span><span class='ace_text'> {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>error</span><span class='ace_text'>(</span><span class='ace_variable'>$a:INVALID_USERNAME_OR_PASSWORD</span><span class='ace_text'>, </span><span class='ace_string'>&quot;Invalid username or password&quot;</span><span class='ace_text'>)    </span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>  } </span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> a:logout()</span><span><br /><span class='ace_line'><span class='ace_keyword'>as</span><span class='ace_text'> </span><span class='ace_keyword'>empty-sequence</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>session:invalidate</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> a:update-password(</span><span class='ace_variable'>$username</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string, </span><span class='ace_variable'>$new-password</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$account</span><span class='ace_text'> := </span><span class='ace_support ace_function'>idx:probe-index-point-value</span><span class='ace_text'>(</span><span class='ace_variable'>$a:account</span><span class='ace_text'>, </span><span class='ace_variable'>$username</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>replace</span><span class='ace_text'> </span><span class='ace_keyword'>value</span><span class='ace_text'> </span><span class='ace_keyword'>of</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> </span><span class='ace_variable'>$account</span><span class='ace_text'>/@password </span><span class='ace_keyword'>with</span><span class='ace_text'> </span><span class='ace_support ace_function'>hash:sha1</span><span class='ace_text'>(</span><span class='ace_variable'>$new-password</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>updating</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> a:upsert(</span><span class='ace_variable'>$source</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> node(), </span><span class='ace_variable'>$target</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> node()?, </span><span class='ace_variable'>$replacement</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> node()*)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>if</span><span class='ace_text'>(</span><span class='ace_support ace_function'>exists</span><span class='ace_text'>(</span><span class='ace_variable'>$target</span><span class='ace_text'>)) </span><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>replace</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> </span><span class='ace_variable'>$target</span><span class='ace_text'> </span><span class='ace_keyword'>with</span><span class='ace_text'> </span><span class='ace_variable'>$replacement</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>insert</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> </span><span class='ace_variable'>$replacement</span><span class='ace_text'> </span><span class='ace_keyword'>into</span><span class='ace_text'> </span><span class='ace_variable'>$source</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>(:</span><span><br /><span class='ace_line'><span class='ace_text'> : Copyright 2010 28msec Inc.</span><span><br /><span class='ace_line'><span class='ace_text'> :)</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> guestbook = </span><span class='ace_string'>&quot;http://www.28msec.com/templates/guestbook/guestbook&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> req = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/http/request&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> resp = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/http/response&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>collection</span><span class='ace_text'> guestbook:entries </span><span class='ace_keyword'>as</span><span class='ace_text'> node()*;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;guestbook:entries&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> guestbook:add()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'> </span><span class='ace_support ace_function'>db:insert-nodes</span><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'>,</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>entry</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>author</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>req:parameter-values</span><span class='ace_text'>(</span><span class='ace_string'>&quot;author&quot;</span><span class='ace_text'>)}</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>date</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>fn:current-date</span><span class='ace_text'>()}</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>time</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>fn:current-time</span><span class='ace_text'>()}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>      {</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span class='ace_support ace_function'>req:parameter-values</span><span class='ace_text'>(</span><span class='ace_string'>&quot;text&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>      }</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;/</span><span class='ace_meta ace_tag'>entry</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>  );</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>guestbook:list</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> guestbook:list() {</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>resp:set-content-type</span><span class='ace_text'>(</span><span class='ace_string'>&quot;text/html&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$entries</span><span class='ace_text'> := </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$e</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>db:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>                  </span><span class='ace_keyword'>order</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_support ace_function'>xs:date</span><span class='ace_text'>(</span><span class='ace_variable'>$e</span><span class='ace_text'>/@date), </span><span class='ace_support ace_function'>xs:time</span><span class='ace_text'>(</span><span class='ace_variable'>$e</span><span class='ace_text'>/@time)</span><span><br /><span class='ace_line'><span class='ace_text'>                  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_variable'>$e</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> := </span><span class='ace_support ace_function'>fn:count</span><span class='ace_text'>(</span><span class='ace_variable'>$entries</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>if</span><span class='ace_text'>(</span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_constant'>0</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>then</span><span class='ace_text'>    </span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>entry</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;No entries, yet.&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$entry</span><span class='ace_text'> </span><span class='ace_keyword'>at</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_variable'>$entries</span><span class='ace_text'>[</span><span class='ace_support ace_function'>position</span><span class='ace_text'>() </span><span class='ace_keyword'>gt</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> </span><span class='ace_constant'>5</span><span class='ace_text'>]</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$numbering</span><span class='ace_text'> := </span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword'>lt</span><span class='ace_text'> </span><span class='ace_constant'>5</span><span class='ace_text'>) </span><span class='ace_keyword'>then</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'> </span><span class='ace_keyword'>else</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> ( </span><span class='ace_constant'>5</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'>) </span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>return</span><span class='ace_text'> &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>entry</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>header</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$entry</span><span class='ace_text'>/@author)}&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>content</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$entry</span><span class='ace_text'>/text()}&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>datetime</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$entry</span><span class='ace_text'>/@datetime)}&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>               &lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> api = </span><span class='ace_string'>&quot;http://www.28msec.com/lib/api-doc&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$api:doc</span><span class='ace_text'> := &lt;</span><span class='ace_meta ace_tag'>documentation</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>id</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>rest-api</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>  &lt;</span><span class='ace_meta ace_tag'>section</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>id</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>kb</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>label</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>Knowledge Base</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>method</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>id</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>edit</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>label</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>Edit Metadata</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>method</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>POST</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>url</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>/kb</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>description</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>            Edit metadata about about the knowledge base.</span><span><br /><span class='ace_line'><span class='ace_text'>            It can be the knowledge base title or description;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;/</span><span class='ace_meta ace_tag'>description</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;</span><span class='ace_meta ace_tag'>params</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>            &lt;</span><span class='ace_meta ace_tag'>description</span><span class='ace_text'>&gt;While no specific parameter is required, at least one of these parameters should be provided when executing this method.&lt;/</span><span class='ace_meta ace_tag'>description</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>            &lt;</span><span class='ace_meta ace_tag'>param</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                </span><span><br /><span class='ace_line'><span class='ace_text'>            &lt;/</span><span class='ace_meta ace_tag'>param</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>        &lt;/</span><span class='ace_meta ace_tag'>params</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;/</span><span class='ace_meta ace_tag'>method</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>  &lt;</span><span class='ace_meta ace_tag'>section</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span><br /><span class='ace_line'><span class='ace_text'>&lt;/</span><span class='ace_meta ace_tag'>documentation</span><span class='ace_text'>&gt;;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> s = </span><span class='ace_string'>&quot;http://www.28msec.com/cloud9/lib/socket&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> date = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/datetime&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> random = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/random&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> base64 = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/converters/base64&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> json = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/converters/json&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> req = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/http/request&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> res = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/http/response&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> sleep = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/sleep&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> store = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/store&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> j = </span><span class='ace_string'>&quot;http://john.snelson.org.uk/parsing-json-into-xquery&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>collection</span><span class='ace_text'> s:clients </span><span class='ace_keyword'>as</span><span class='ace_text'> element(client);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:clients</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:clients'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private %an:automatic %an:value-equality </span><span class='ace_keyword'>index</span><span class='ace_text'> s:client</span><span><br /><span class='ace_line'><span class='ace_keyword'>on</span><span class='ace_text'> </span><span class='ace_keyword'>nodes</span><span class='ace_text'> </span><span class='ace_support ace_function'>db:collection</span><span class='ace_text'>(</span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:clients'</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_support ace_function'>xs:string</span><span class='ace_text'>(@id) </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string;  </span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:client</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:client'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>collection</span><span class='ace_text'> s:messages </span><span class='ace_keyword'>as</span><span class='ace_text'> element(message);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:messages</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:messages'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private %an:automatic %an:value-equality </span><span class='ace_keyword'>index</span><span class='ace_text'> s:message</span><span><br /><span class='ace_line'><span class='ace_keyword'>on</span><span class='ace_text'> </span><span class='ace_keyword'>nodes</span><span class='ace_text'> </span><span class='ace_support ace_function'>db:collection</span><span class='ace_text'>(</span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:messages'</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_support ace_function'>xs:string</span><span class='ace_text'>(@session-id) </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:message</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:message'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:disconnect</span><span class='ace_text'>     := </span><span class='ace_constant'>0</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:connect</span><span class='ace_text'>        := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:heartbeat</span><span class='ace_text'>      := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:msg</span><span class='ace_text'>            := </span><span class='ace_constant'>3</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:json</span><span class='ace_text'>           := </span><span class='ace_constant'>4</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:event</span><span class='ace_text'>          := </span><span class='ace_constant'>5</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:acknowledgment</span><span class='ace_text'> := </span><span class='ace_constant'>6</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:error</span><span class='ace_text'>          := </span><span class='ace_constant'>7</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:noop</span><span class='ace_text'>           := </span><span class='ace_constant'>8</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:heartbeat-timeout</span><span class='ace_text'>  </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>20</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:connection-timeout</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>20</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:listeners</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> item()* := ();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:handshake</span><span class='ace_text'>               </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:handshake'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:transport-not-supported</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>'s:transport-not-supported'</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:supported-transports</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string+ := </span><span class='ace_string'>&quot;xhr-polling&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:transport</span><span class='ace_text'>   </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string? := ();</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$s:session-id</span><span class='ace_text'>  </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string? := ();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> s:id() </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string? { </span><span class='ace_variable'>$s:session-id</span><span class='ace_text'> };</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> s:on(</span><span class='ace_variable'>$event-name</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string, </span><span class='ace_variable'>$handler</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> function(*))</span><span><br /><span class='ace_line'><span class='ace_text'>as empty-sequence()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  $s:listeners :=  ($s:listeners, $event-name, $handler);</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:handler($event-name as xs:string)</span><span><br /><span class='ace_line'><span class='ace_text'>as function(*)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  for $handler at $i in $s:listeners</span><span><br /><span class='ace_line'><span class='ace_text'>  let $handler-event-name := if($handler instance of xs:string) then $handler else ()</span><span><br /><span class='ace_line'><span class='ace_text'>  where $handler-event-name = $event-name</span><span><br /><span class='ace_line'><span class='ace_text'>  return $s:listeners[$i + 1]</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare function s:clients()</span><span><br /><span class='ace_line'><span class='ace_text'>as element(client)*</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  db:collection($s:clients)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare function s:get()</span><span><br /><span class='ace_line'><span class='ace_text'>as element(client)?</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  idx:probe-index-point-value($s:client, $s:session-id)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:listen()</span><span><br /><span class='ace_line'><span class='ace_text'>as xs:string</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  try {</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      s:handshake();</span><span><br /><span class='ace_line'><span class='ace_text'>      for $message in s:messages()</span><span><br /><span class='ace_line'><span class='ace_text'>      let $type := number($message/@type)</span><span><br /><span class='ace_line'><span class='ace_text'>      return</span><span><br /><span class='ace_line'><span class='ace_text'>        switch ($type)</span><span><br /><span class='ace_line'><span class='ace_text'>          case $s:disconnect</span><span><br /><span class='ace_line'><span class='ace_text'>          return s:disconnect();</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>          case $s:msg</span><span><br /><span class='ace_line'><span class='ace_text'>          return</span><span><br /><span class='ace_line'><span class='ace_text'>            for $handler in s:handler(&quot;message&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>            return $handler($message/text());</span><span><br /><span class='ace_line'><span class='ace_text'>            </span><span><br /><span class='ace_line'><span class='ace_text'>          case $s:json</span><span><br /><span class='ace_line'><span class='ace_text'>          return</span><span><br /><span class='ace_line'><span class='ace_text'>            for $handler in s:handler(&quot;message&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>            return $handler($message/text());</span><span><br /><span class='ace_line'><span class='ace_text'>          </span><span><br /><span class='ace_line'><span class='ace_text'>          case $s:event</span><span><br /><span class='ace_line'><span class='ace_text'>          return</span><span><br /><span class='ace_line'><span class='ace_text'>            let $event-name := json:parse($message/text())/j:pair[@name=&quot;name&quot;]/text()</span><span><br /><span class='ace_line'><span class='ace_text'>            for $handler in s:handler($event-name)</span><span><br /><span class='ace_line'><span class='ace_text'>            return $handler($message/text());</span><span><br /><span class='ace_line'><span class='ace_text'>            </span><span><br /><span class='ace_line'><span class='ace_text'>        default return ();</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>      if(req:method-get()) then { </span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>        s:heartbeat();</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>        variable $messages := s:close();</span><span><br /><span class='ace_line'><span class='ace_text'>        variable $timeout  := 0;</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>        if(true()) then</span><span><br /><span class='ace_line'><span class='ace_text'>          (: We have a padding of 3/4 the connection timeout :)</span><span><br /><span class='ace_line'><span class='ace_text'>          while(empty($messages) and $timeout lt ($s:connection-timeout * 3 div 4)) {</span><span><br /><span class='ace_line'><span class='ace_text'>            sleep:millis(50);</span><span><br /><span class='ace_line'><span class='ace_text'>            $messages := s:close();</span><span><br /><span class='ace_line'><span class='ace_text'>            $timeout := $timeout + 0.05;</span><span><br /><span class='ace_line'><span class='ace_text'>          }</span><span><br /><span class='ace_line'><span class='ace_text'>        else();</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span><br /><span class='ace_line'><span class='ace_text'>        if(empty($messages)) then</span><span><br /><span class='ace_line'><span class='ace_text'>          &quot;8::&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>        else</span><span><br /><span class='ace_line'><span class='ace_text'>          $messages</span><span><br /><span class='ace_line'><span class='ace_text'>          </span><span><br /><span class='ace_line'><span class='ace_text'>      } else {</span><span><br /><span class='ace_line'><span class='ace_text'>        &quot;1&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>      }</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>  } catch s:handshake {</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      $err:description</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:connect()</span><span><br /><span class='ace_line'><span class='ace_text'>as empty-sequence()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  $s:session-id := random:uuid();</span><span><br /><span class='ace_line'><span class='ace_text'>  variable $client := idx:probe-index-point-value($s:client, $s:session-id);</span><span><br /><span class='ace_line'><span class='ace_text'>  if(empty($client)) then </span><span><br /><span class='ace_line'><span class='ace_text'>    db:insert-nodes($s:clients, &lt;client id=&quot;{$s:session-id}&quot; last-seen=&quot;{date:current-dateTime()}&quot; /&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>  else</span><span><br /><span class='ace_line'><span class='ace_text'>    error();</span><span><br /><span class='ace_line'><span class='ace_text'>  s:send-impl(&quot;1::&quot;);</span><span><br /><span class='ace_line'><span class='ace_text'>  for $handler in s:handler(&quot;connect&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>  return $handler($s:session-id);</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private %an:sequential function s:close()</span><span><br /><span class='ace_line'><span class='ace_text'>as xs:string?</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  store:flush();</span><span><br /><span class='ace_line'><span class='ace_text'>  variable $client := idx:probe-index-point-value($s:client, $s:session-id);</span><span><br /><span class='ace_line'><span class='ace_text'>  variable $messages := (</span><span><br /><span class='ace_line'><span class='ace_text'>    for $message in idx:probe-index-point-value($s:message, $s:session-id)</span><span><br /><span class='ace_line'><span class='ace_text'>    let $datetime := xs:dateTime($message/@datetime)</span><span><br /><span class='ace_line'><span class='ace_text'>    order by $datetime ascending</span><span><br /><span class='ace_line'><span class='ace_text'>    return $message);</span><span><br /><span class='ace_line'><span class='ace_text'>  db:delete-nodes($messages);</span><span><br /><span class='ace_line'><span class='ace_text'>  if(count($messages) = 1) then {</span><span><br /><span class='ace_line'><span class='ace_text'>    $messages/text()</span><span><br /><span class='ace_line'><span class='ace_text'>  } else if(empty($messages)) then {</span><span><br /><span class='ace_line'><span class='ace_text'>    ()</span><span><br /><span class='ace_line'><span class='ace_text'>  } else {</span><span><br /><span class='ace_line'><span class='ace_text'>    string-join(</span><span><br /><span class='ace_line'><span class='ace_text'>      for $message in $messages</span><span><br /><span class='ace_line'><span class='ace_text'>      return</span><span><br /><span class='ace_line'><span class='ace_text'>        &quot;&amp;#65533;&quot; || string-length($message/text()) || &quot;&amp;#65533;&quot; || $message/text()</span><span><br /><span class='ace_line'><span class='ace_text'>      , &quot;&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>   }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private %an:sequential function s:disconnect()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  db:delete-nodes(idx:probe-index-point-value($s:client, $s:session-id));</span><span><br /><span class='ace_line'><span class='ace_text'>  for $handler in s:handler(&quot;disconnect&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>  return $handler($s:session-id);</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private %an:sequential function s:heartbeat()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  for $disconnected in db:collection($s:clients)[(date:current-dateTime() - xs:dateTime(@last-seen)) gt xs:dayTimeDuration(&quot;PT&quot; || $s:heartbeat-timeout || &quot;S&quot;)]</span><span><br /><span class='ace_line'><span class='ace_text'>  return {</span><span><br /><span class='ace_line'><span class='ace_text'>    variable $id := string($disconnected/@id);</span><span><br /><span class='ace_line'><span class='ace_text'>    db:delete-nodes($disconnected);</span><span><br /><span class='ace_line'><span class='ace_text'>    for $handler in s:handler(&quot;disconnect&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>    return $handler($id);</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  variable $client := idx:probe-index-point-value($s:client, $s:session-id);</span><span><br /><span class='ace_line'><span class='ace_text'>  if(empty($client)) then {</span><span><br /><span class='ace_line'><span class='ace_text'>     for $handler in s:handler(&quot;disconnect&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>     return $handler($s:session-id); </span><span><br /><span class='ace_line'><span class='ace_text'>  } else {</span><span><br /><span class='ace_line'><span class='ace_text'>    replace value of node $client/@last-seen with date:current-dateTime();</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:broadcast($event-name as xs:string, $data as xs:string)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  s:emit($event-name, $data, true())</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:emit($event-name as xs:string, $data as xs:string)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  s:emit($event-name, $data, false())</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:emit($event-name as xs:string, $data as xs:string, $broadcast as xs:boolean)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  s:send-impl(&quot;5:::&quot; || '{&quot;name&quot;:' || ' &quot;' || $event-name || '&quot;, &quot;args&quot;: [' || $data || &quot;]}&quot;, $broadcast)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %an:sequential function s:send-impl($message as xs:string)</span><span><br /><span class='ace_line'><span class='ace_text'>as empty-sequence()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  s:send-impl($message, false())</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private %an:sequential function s:send-impl($message as xs:string, $broadcast as xs:boolean)</span><span><br /><span class='ace_line'><span class='ace_text'>as empty-sequence()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  for $session-id in (if($broadcast) then db:collection($s:clients)/@id/string(.) else $s:session-id)</span><span><br /><span class='ace_line'><span class='ace_text'>  return</span><span><br /><span class='ace_line'><span class='ace_text'>    db:insert-nodes($s:messages, </span><span><br /><span class='ace_line'><span class='ace_text'>                    &lt;message datetime=&quot;{date:current-dateTime()}&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>                             session-id=&quot;{$session-id}&quot;&gt;{$message}&lt;/message&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private %an:sequential function s:handshake()</span><span><br /><span class='ace_line'><span class='ace_text'>{ </span><span><br /><span class='ace_line'><span class='ace_text'>  res:set-content-type(&quot;text/plain&quot;);</span><span><br /><span class='ace_line'><span class='ace_text'>  variable $segments := tokenize(req:path(), &quot;/&quot;)[. != &quot;&quot;];</span><span><br /><span class='ace_line'><span class='ace_text'>  $s:transport := $segments[3 + 1];</span><span><br /><span class='ace_line'><span class='ace_text'>  $s:session-id := $segments[4 + 1];</span><span><br /><span class='ace_line'><span class='ace_text'>  if($s:transport != $s:supported-transports) then</span><span><br /><span class='ace_line'><span class='ace_text'>    error($res:service-unavailable);</span><span><br /><span class='ace_line'><span class='ace_text'>  else</span><span><br /><span class='ace_line'><span class='ace_text'>    ();</span><span><br /><span class='ace_line'><span class='ace_text'>  (: If the transport is empty, it's an handshake :)</span><span><br /><span class='ace_line'><span class='ace_text'>  if(empty($s:transport)) then {</span><span><br /><span class='ace_line'><span class='ace_text'>    s:connect();</span><span><br /><span class='ace_line'><span class='ace_text'>    error($s:handshake, $s:session-id || &quot;:&quot; || $s:heartbeat-timeout || &quot;:&quot; || $s:connection-timeout || &quot;:&quot; || string-join($s:supported-transports, &quot;,&quot;));</span><span><br /><span class='ace_line'><span class='ace_text'>  } else{}</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private function s:messages()</span><span><br /><span class='ace_line'><span class='ace_text'>as element(message)*</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  let $payload := if(req:method-get()) then () else req:text-content()</span><span><br /><span class='ace_line'><span class='ace_text'>  return</span><span><br /><span class='ace_line'><span class='ace_text'>    if(empty($payload)) then</span><span><br /><span class='ace_line'><span class='ace_text'>      ()</span><span><br /><span class='ace_line'><span class='ace_text'>    else if(not(starts-with($payload, &quot;&amp;#65533;&quot;))) then</span><span><br /><span class='ace_line'><span class='ace_text'>      s:parse-message($payload)</span><span><br /><span class='ace_line'><span class='ace_text'>    else</span><span><br /><span class='ace_line'><span class='ace_text'>      let $tokens := tokenize($payload, &quot;&amp;#65533;(\d)+&amp;#65533;&quot;)[. != &quot;&quot;]</span><span><br /><span class='ace_line'><span class='ace_text'>      for $token in $tokens</span><span><br /><span class='ace_line'><span class='ace_text'>      return s:parse-message($token)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private function s:parse-message($payload as xs:string)</span><span><br /><span class='ace_line'><span class='ace_text'>as element(message)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  let $segments := tokenize($payload, &quot;:&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>  let $type := number($segments[1])</span><span><br /><span class='ace_line'><span class='ace_text'>  let $id := $segments[2]</span><span><br /><span class='ace_line'><span class='ace_text'>  let $endpoint := $segments[3]</span><span><br /><span class='ace_line'><span class='ace_text'>  let $data := string-join(subsequence($segments, 4), &quot;:&quot;)</span><span><br /><span class='ace_line'><span class='ace_text'>  return</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;message id=&quot;{$id}&quot; endpoint=&quot;{$endpoint}&quot; type=&quot;{$type}&quot;&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      $data</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;/message&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare %private function s:serialize-message($message as element(message))</span><span><br /><span class='ace_line'><span class='ace_text'>as xs:string</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  let $type := string($message/@type)</span><span><br /><span class='ace_line'><span class='ace_text'>  let $id   := string($message/@id)</span><span><br /><span class='ace_line'><span class='ace_text'>  let $endpoint := string($message/@endpoint)</span><span><br /><span class='ace_line'><span class='ace_text'>  let $data := $message/text()</span><span><br /><span class='ace_line'><span class='ace_text'>  return</span><span><br /><span class='ace_line'><span class='ace_text'>    $type || &quot;:&quot; || $id || &quot;:&quot; || $endpoint || &quot;:&quot; || $data</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>declare function s:foo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;script type=&quot;text/javascript&quot;&gt;&lt;![CDATA[</span><span><br /><span class='ace_line'><span class='ace_text'>$(function(){</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span><br /><span class='ace_line'><span class='ace_text'>});        </span><span><br /><span class='ace_line'><span class='ace_text'>    //]]&gt;&lt;/script&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>(:</span><span><br /><span class='ace_line'><span class='ace_text'> : Copyright 2010 28msec Inc.</span><span><br /><span class='ace_line'><span class='ace_text'> :)</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> guestbook = </span><span class='ace_string'>&quot;http://www.28msec.com/templates/guestbook/guestbook&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> http = </span><span class='ace_string'>&quot;http://www.28msec.com/modules/http&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> xqddf = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/xqddf&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>collection</span><span class='ace_text'> guestbook:entries </span><span class='ace_keyword'>as</span><span class='ace_text'> node()*;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:QName := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;guestbook:entries&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> guestbook:add()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>http:set-header</span><span class='ace_text'>(</span><span class='ace_string'>&quot;Cache-Control&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;no-cache&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>xqddf:insert-nodes</span><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'>,</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>entry</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>author</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>http:get-parameters</span><span class='ace_text'>(</span><span class='ace_string'>&quot;author&quot;</span><span class='ace_text'>)}</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>date</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>fn:current-date</span><span class='ace_text'>()}</span><span class='ace_string'>&quot;</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>time</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>fn:current-time</span><span class='ace_text'>()}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>      {</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span class='ace_support ace_function'>http:get-parameters</span><span class='ace_text'>(</span><span class='ace_string'>&quot;text&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>      }</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;/</span><span class='ace_meta ace_tag'>entry</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>  );</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_support ace_function'>guestbook:list</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %an:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> guestbook:list() {</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>http:set-header</span><span class='ace_text'>(</span><span class='ace_string'>&quot;Cache-Control&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;no-cache&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$entries</span><span class='ace_text'> := </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$e</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>xqddf:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$guestbook:entries</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>                  </span><span class='ace_keyword'>order</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_support ace_function'>xs:date</span><span class='ace_text'>(</span><span class='ace_variable'>$e</span><span class='ace_text'>/@date), </span><span class='ace_support ace_function'>xs:time</span><span class='ace_text'>(</span><span class='ace_variable'>$e</span><span class='ace_text'>/@time)</span><span><br /><span class='ace_line'><span class='ace_text'>                  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_variable'>$e</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> := </span><span class='ace_support ace_function'>fn:count</span><span class='ace_text'>(</span><span class='ace_variable'>$entries</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>if</span><span class='ace_text'>(</span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_constant'>0</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>then</span><span class='ace_text'>    </span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>entry</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;No entries, yet.&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$entry</span><span class='ace_text'> </span><span class='ace_keyword'>at</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_variable'>$entries</span><span class='ace_text'>[</span><span class='ace_support ace_function'>position</span><span class='ace_text'>() </span><span class='ace_keyword'>gt</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> </span><span class='ace_constant'>5</span><span class='ace_text'>]</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$numbering</span><span class='ace_text'> := </span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword'>lt</span><span class='ace_text'> </span><span class='ace_constant'>5</span><span class='ace_text'>) </span><span class='ace_keyword'>then</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'> </span><span class='ace_keyword'>else</span><span class='ace_text'> </span><span class='ace_variable'>$num_entries</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> ( </span><span class='ace_constant'>5</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> </span><span class='ace_variable'>$pos</span><span class='ace_text'>) </span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>return</span><span class='ace_text'> &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>entry</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>header</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$entry</span><span class='ace_text'>/@author)}&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>content</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$entry</span><span class='ace_text'>/text()}&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>                 &lt;</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>class</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_string'>datetime</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$entry</span><span class='ace_text'>/@datetime)}&lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>               &lt;/</span><span class='ace_meta ace_tag'>div</span><span class='ace_text'>&gt;;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_support ace_function'>db:insert-nodes</span><span class='ace_text'>(</span><span class='ace_variable'>$a:accounts</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>account</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>username</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$username</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>                                      </span><span class='ace_meta ace_tag'>password</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_support ace_function'>hash:sha1</span><span class='ace_text'>(</span><span class='ace_variable'>$password</span><span class='ace_text'>)}</span><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>                                      </span><span class='ace_meta ace_tag'>email</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$email</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'> /&gt;);</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>import module namespace raytracer=&quot;http://www.xqsharp.com/raytracer&quot; at &quot;raytracer.xqlib&quot;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> scene=</span><span class='ace_string'>&quot;http://www.xqsharp.com/raytracer/scene&quot;</span><span class='ace_text'> </span><span class='ace_keyword'>at</span><span class='ace_text'> </span><span class='ace_string'>&quot;scene.xqlib&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> serialization=</span><span class='ace_string'>&quot;http://www.xqsharp.com/serialization&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>option</span><span class='ace_text'> serialization:method </span><span class='ace_string'>&quot;text&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>option</span><span class='ace_text'> serialization:encoding </span><span class='ace_string'>&quot;us-ascii&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$width</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>10</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$height</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>10</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$scene</span><span class='ace_text'> := </span><span class='ace_support ace_function'>scene:prepare-scene</span><span class='ace_text'>(</span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;scene.xml&quot;</span><span class='ace_text'>)/scene);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>string-join</span><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_text'>  (</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_comment'>(: Magic number identifying the file as a &quot;plain&quot; ppm file :)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>&quot;P3&quot;</span><span class='ace_text'>,</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_comment'>(: width and height :)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_support ace_function'>string-join</span><span class='ace_text'>((</span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$width</span><span class='ace_text'>), </span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$height</span><span class='ace_text'>)), </span><span class='ace_string'>&quot; &quot;</span><span class='ace_text'>),</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_comment'>(: Maximum color value :)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>&quot;255&quot;</span><span class='ace_text'>,</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_comment'>(:</span><span><br /><span class='ace_line'><span class='ace_comment'>     : Now the pixel data.  We take each pixel in the image, and recenter it, so that the</span><span><br /><span class='ace_line'><span class='ace_comment'>     : y co-ordinate ($y-recentered) ranges from -0.5 at the bottom of the image, to 0.5 </span><span><br /><span class='ace_line'><span class='ace_comment'>     : at the top of the image.</span><span><br /><span class='ace_line'><span class='ace_comment'>     :        </span><span><br /><span class='ace_line'><span class='ace_comment'>     : The aspect ratio is used to &quot;stretch&quot; the range of x-coordinate values to stop the</span><span><br /><span class='ace_line'><span class='ace_comment'>     : image from being skewed.</span><span><br /><span class='ace_line'><span class='ace_comment'>     :)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$aspect-ratio</span><span class='ace_text'> := </span><span class='ace_variable'>$width</span><span class='ace_text'> </span><span class='ace_keyword'>div</span><span class='ace_text'> </span><span class='ace_variable'>$height</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_variable'>$height</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$y-recentered</span><span class='ace_text'> := ((</span><span class='ace_keyword ace_operator'>-</span><span class='ace_variable'>$y</span><span class='ace_text'> </span><span class='ace_keyword'>div</span><span class='ace_text'> </span><span class='ace_variable'>$height</span><span class='ace_text'>) </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>0.5</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_variable'>$width</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$x-recentered</span><span class='ace_text'> := ((</span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>div</span><span class='ace_text'> </span><span class='ace_variable'>$width</span><span class='ace_text'>) </span><span class='ace_keyword ace_operator'>-</span><span class='ace_text'> </span><span class='ace_constant'>0.5</span><span class='ace_text'>) </span><span class='ace_keyword ace_operator'>*</span><span class='ace_text'> </span><span class='ace_variable'>$aspect-ratio</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_comment'>(: plot-pixel returns us the rgb values of the color of this pixel.  We convert these</span><span><br /><span class='ace_line'><span class='ace_comment'>         to an integer value in the range [0, 255], and output them. :)</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>string-join</span><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$channel</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>raytracer:plot-pixel</span><span class='ace_text'>(</span><span class='ace_variable'>$scene</span><span class='ace_text'>, </span><span class='ace_variable'>$x-recentered</span><span class='ace_text'>, </span><span class='ace_variable'>$y-recentered</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_support ace_function'>floor</span><span class='ace_text'>(</span><span class='ace_variable'>$channel</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>*</span><span class='ace_text'> </span><span class='ace_constant'>255</span><span class='ace_text'>)),</span><span><br /><span class='ace_line'><span class='ace_text'>        </span><span class='ace_string'>&quot; &quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  ),</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>), </span><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>'FitnessCenter.xml'</span><span class='ace_text'>)//*</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_keyword'>rename</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> </span><span class='ace_support ace_function'>QName</span><span class='ace_text'>(</span><span class='ace_string'>'http://www.gym.com'</span><span class='ace_text'>, </span><span class='ace_support ace_function'>concat</span><span class='ace_text'>(</span><span class='ace_string'>'gym:'</span><span class='ace_text'>, </span><span class='ace_support ace_function'>local-name</span><span class='ace_text'>(</span><span class='ace_variable'>$i</span><span class='ace_text'>)));</span><span><br /><span class='ace_line'><span class='ace_support ace_function'>fn:doc</span><span class='ace_text'>(</span><span class='ace_string'>'FitnessCenter.xml'</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> xqd = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/xqdoc&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>schema</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> xqds = </span><span class='ace_string'>&quot;http://www.xqdoc.org/1.0&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> err = </span><span class='ace_string'>&quot;http://www.w3.org/2005/xqt-errors&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>try</span><span class='ace_text'> {</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>xqd:xqdoc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;gdata_error.xqlib&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>} catch *  {</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$err:code</span><span class='ace_text'>, </span><span class='ace_variable'>$err:description</span><span><br /><span class='ace_line'><span class='ace_text'>},</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>try</span><span class='ace_text'> {</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>xqd:xqdoc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;gdata_error.xqlib&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>} catch *  {</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$err:code</span><span class='ace_text'>, </span><span class='ace_variable'>$err:description</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>break</span><span class='ace_text'> </span><span class='ace_keyword'>loop</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;{</span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span class='ace_constant'>1</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>element</span><span class='ace_text'> book {</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>attribute</span><span class='ace_text'> isbn {</span><span class='ace_string'>&quot;isbn-0060229357&quot;</span><span class='ace_text'> },</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>element</span><span class='ace_text'> title { </span><span class='ace_constant'>1</span><span class='ace_text'>; </span><span class='ace_string'>&quot;Harold and the Purple Crayon&quot;</span><span class='ace_text'> }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>element</span><span class='ace_text'> book {</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>attribute</span><span class='ace_text'> isbn { </span><span class='ace_constant'>1</span><span class='ace_text'>; </span><span class='ace_string'>&quot;isbn-0060229357&quot;</span><span class='ace_text'> },</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>element</span><span class='ace_text'> title { </span><span class='ace_constant'>1</span><span class='ace_text'>; </span><span class='ace_string'>&quot;Harold and the Purple Crayon&quot;</span><span class='ace_text'> }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>import module namespace r = &quot;http://www.zorba-xquery.com/modules/random&quot;;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_comment'>(: test call to a nondeterministic function in an element constructor :)</span><span><br /><span class='ace_line'><span class='ace_keyword'>element</span><span class='ace_text'> book {</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>element</span><span class='ace_text'> title { </span><span class='ace_support ace_function'>r:random</span><span class='ace_text'>() ; </span><span class='ace_string'>&quot;Harold and the Purple Crayon&quot;</span><span class='ace_text'> }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>import module namespace ddl = &quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_comment'>(: test call to a side-effecting function in an element constructor :)</span><span><br /><span class='ace_line'><span class='ace_keyword'>element</span><span class='ace_text'> book {</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>element</span><span class='ace_text'> title { </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_support ace_function'>fn:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;foo:bar&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;blub&quot;</span><span class='ace_text'>)) ; </span><span class='ace_string'>&quot;Harold and the Purple Crayon&quot;</span><span class='ace_text'> },</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>element</span><span class='ace_text'> blub { </span><span class='ace_support ace_function'>dml:apply-insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_support ace_function'>fn:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;foo:bar&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;blub&quot;</span><span class='ace_text'>), &lt;</span><span class='ace_meta ace_tag'>blub2</span><span class='ace_text'>/&gt;) }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> op = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/options/features&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>option</span><span class='ace_text'> op:disable </span><span class='ace_string'>&quot;scripting&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>{ }</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;{ </span><span class='ace_constant'>1</span><span class='ace_text'>; }&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;</span><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;{ </span><span class='ace_constant'>1</span><span class='ace_text'>; () }&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;</span><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;content{ </span><span class='ace_constant'>1</span><span class='ace_text'>; }content&lt;/</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;</span><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;content{ </span><span class='ace_constant'>1</span><span class='ace_text'>; () }content&lt;/</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;</span><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;content{ }content&lt;/</span><span class='ace_meta ace_tag'>elem</span><span class='ace_text'>&gt;</span><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:magic-trick() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> (</span><span class='ace_string'>&quot;magician's hat:&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;rabbit&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> (</span><span class='ace_string'>&quot;dead code&quot;</span><span class='ace_text'>); </span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:professional-magician() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$res</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:magic-trick</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_variable'>$res</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:professional-magician</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_constant'>1</span><span class='ace_text'>, exit </span><span class='ace_support ace_function'>returning</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:searchFor(</span><span class='ace_variable'>$obj</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string) </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$obj</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:trick(</span><span class='ace_variable'>$object</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string) </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$s</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:searchFor</span><span class='ace_text'>(</span><span class='ace_variable'>$object</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> (</span><span class='ace_string'>&quot;hat:&quot;</span><span class='ace_text'>, </span><span class='ace_variable'>$s</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_string'>&quot;THIS IS THE SECRET&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:magician() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$s</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:trick</span><span class='ace_text'>(</span><span class='ace_string'>&quot;rabbit&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_variable'>$s</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:magician</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:searchFor(</span><span class='ace_variable'>$obj</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string) </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$obj</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:trick(</span><span class='ace_variable'>$object</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string) </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$s</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:searchFor</span><span class='ace_text'>(</span><span class='ace_variable'>$object</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_variable'>$s</span><span class='ace_text'>) </span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_string'>&quot;hat&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>else</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:trick</span><span class='ace_text'>(</span><span class='ace_string'>&quot;foo&quot;</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:cook() </span><span class='ace_keyword'>as</span><span class='ace_text'> element(soup)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> </span><span class='ace_string'>&quot;garbage&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:cook</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test3()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test3</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_constant'>0</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>, </span><span class='ace_constant'>2</span><span class='ace_text'>, </span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> := { </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'>; }</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_constant'>0</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> := { </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>; }</span><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>, </span><span class='ace_constant'>2</span><span class='ace_text'>, </span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test1()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test2()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>cc1</span><span class='ace_text'>/&gt;&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;, &lt;</span><span class='ace_meta ace_tag'>e</span><span class='ace_text'>/&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>/&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$k</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>4</span><span class='ace_text'>, </span><span class='ace_constant'>5</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>local:test2</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>, </span><span class='ace_constant'>2</span><span class='ace_text'>, </span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span class='ace_text'> &lt;</span><span class='ace_meta ace_tag'>res</span><span class='ace_text'>&gt;{</span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_variable'>$i</span><span class='ace_text'>/*) </span><span class='ace_keyword'>then</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'>/* </span><span class='ace_keyword'>else</span><span class='ace_text'> </span><span class='ace_support ace_function'>local-name-from-QName</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)}&lt;/</span><span class='ace_meta ace_tag'>res</span><span class='ace_text'>&gt; </span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>,</span><span class='ace_constant'>2</span><span class='ace_text'>,</span><span class='ace_constant'>3</span><span class='ace_text'>,</span><span class='ace_constant'>4</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>switch</span><span class='ace_text'> (</span><span class='ace_variable'>$mode</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>case</span><span class='ace_text'> </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_support ace_function'>fn:trace</span><span class='ace_text'>(</span><span class='ace_variable'>$mode</span><span class='ace_text'>, </span><span class='ace_string'>&quot;option mode&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;value&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>'option'</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>case</span><span class='ace_text'> </span><span class='ace_string'>&quot;value&quot;</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_support ace_function'>fn:trace</span><span class='ace_text'>(</span><span class='ace_variable'>$mode</span><span class='ace_text'>, </span><span class='ace_string'>&quot;value mode&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>'value'</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>default</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_string'>&quot;default&quot;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>,</span><span class='ace_constant'>2</span><span class='ace_text'>,</span><span class='ace_constant'>3</span><span class='ace_text'>,</span><span class='ace_constant'>4</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span class='ace_text'> :=</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>switch</span><span class='ace_text'> (</span><span class='ace_variable'>$mode</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>case</span><span class='ace_text'> </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;value&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>&quot;option&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>case</span><span class='ace_text'> </span><span class='ace_string'>&quot;value&quot;</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$mode</span><span class='ace_text'> := </span><span class='ace_string'>&quot;option&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_string'>&quot;value&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>default</span><span class='ace_text'> </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_string'>&quot;default&quot;</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>  &lt;</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$i</span><span class='ace_text'>, </span><span class='ace_variable'>$j</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test3()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>d</span><span class='ace_text'>/&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$item</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_variable'>$item</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>fn:empty</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test3</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;1&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;2&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_constant'>1</span><span class='ace_text'>]/c</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_constant'>1</span><span class='ace_text'>]);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-first</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$x</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test3()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>/&gt;, &lt;</span><span class='ace_meta ace_tag'>d</span><span class='ace_text'>/&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>,</span><span class='ace_constant'>2</span><span class='ace_text'>,</span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$item</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_variable'>$item</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>fn:empty</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test3</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;1&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;2&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_constant'>1</span><span class='ace_text'>]/c</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_support ace_function'>count</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)) </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_variable'>$i</span><span class='ace_text'>]);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-first</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$x</span><span class='ace_text'>}-{</span><span class='ace_variable'>$i</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$x</span><span class='ace_text'>}-{</span><span class='ace_variable'>$i</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;1&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;2&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_constant'>1</span><span class='ace_text'>]/c</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_support ace_function'>count</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)) </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>order</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>descending</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_variable'>$i</span><span class='ace_text'>]);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-first</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$x</span><span class='ace_text'>}-{</span><span class='ace_variable'>$i</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$x</span><span class='ace_text'>}-{</span><span class='ace_variable'>$i</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$gid</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>0</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>{ </span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;sales-records.xml&quot;</span><span class='ace_text'>)/*/record</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$state</span><span class='ace_text'> := </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;stores.xml&quot;</span><span class='ace_text'>)/*/store[store-number </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'>/store-number]/state</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$category</span><span class='ace_text'> := </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;products.xml&quot;</span><span class='ace_text'>)/*/product[name </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'>/product-name]/category</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>group</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_variable'>$state</span><span class='ace_text'>, </span><span class='ace_variable'>$category</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>order</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_variable'>$state</span><span class='ace_text'>, </span><span class='ace_variable'>$category</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$gid</span><span class='ace_text'> := </span><span class='ace_variable'>$gid</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>    &lt;</span><span class='ace_meta ace_tag'>group</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>id</span><span class='ace_text'> = </span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$gid</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>      {</span><span class='ace_variable'>$state</span><span class='ace_text'>, </span><span class='ace_variable'>$category</span><span class='ace_text'>}</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>total-qty</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>sum</span><span class='ace_text'>(</span><span class='ace_variable'>$sales</span><span class='ace_text'>/qty)}&lt;/</span><span class='ace_meta ace_tag'>total-qty</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;/</span><span class='ace_meta ace_tag'>group</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;/</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$gid</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>0</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>{ </span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;sales-records.xml&quot;</span><span class='ace_text'>)/*/record</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$state</span><span class='ace_text'> := </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;stores.xml&quot;</span><span class='ace_text'>)/*/store[store-number </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'>/store-number]/state</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$category</span><span class='ace_text'> := </span><span class='ace_support ace_function'>doc</span><span class='ace_text'>(</span><span class='ace_string'>&quot;products.xml&quot;</span><span class='ace_text'>)/*/product[name </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_variable'>$sales</span><span class='ace_text'>/product-name]/category</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>group</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_variable'>$state</span><span class='ace_text'>, </span><span class='ace_variable'>$category</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$gid</span><span class='ace_text'> := </span><span class='ace_variable'>$gid</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>    &lt;</span><span class='ace_meta ace_tag'>group</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>id</span><span class='ace_text'> = </span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$gid</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>      {</span><span class='ace_variable'>$state</span><span class='ace_text'>, </span><span class='ace_variable'>$category</span><span class='ace_text'>}</span><span><br /><span class='ace_line'><span class='ace_text'>      &lt;</span><span class='ace_meta ace_tag'>total-qty</span><span class='ace_text'>&gt;{</span><span class='ace_support ace_function'>sum</span><span class='ace_text'>(</span><span class='ace_variable'>$sales</span><span class='ace_text'>/qty)}&lt;/</span><span class='ace_meta ace_tag'>total-qty</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>    &lt;/</span><span class='ace_meta ace_tag'>group</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;/</span><span class='ace_meta ace_tag'>result</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$seq</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:string* := ();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'>,</span><span class='ace_constant'>2</span><span class='ace_text'>,</span><span class='ace_constant'>3</span><span class='ace_text'>,</span><span class='ace_constant'>4</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span class='ace_text'>  </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_support ace_function'>empty</span><span class='ace_text'>(</span><span class='ace_variable'>$seq</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$seq</span><span class='ace_text'>:=(</span><span class='ace_variable'>$seq</span><span class='ace_text'>, </span><span class='ace_string'>&quot;empty&quot;</span><span class='ace_text'>, </span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$x</span><span class='ace_text'>));</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$seq</span><span class='ace_text'>:=(</span><span class='ace_variable'>$seq</span><span class='ace_text'>, </span><span class='ace_string'>&quot;full&quot;</span><span class='ace_text'>, </span><span class='ace_support ace_function'>string</span><span class='ace_text'>(</span><span class='ace_variable'>$x</span><span class='ace_text'>));</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_variable'>$seq</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>import module namespace ddl = &quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;1&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;2&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>where</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>&gt;</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>2</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$c</span><span class='ace_text'> := </span><span class='ace_support ace_function'>count</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)) </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_variable'>$i</span><span class='ace_text'>]);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-first</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$c</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$c</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_comment'>(:</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>i , j , c</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>2 , 1 , 3 --&gt; &lt;x i=2 3&gt; &lt;a&gt; &lt;x i=2 3&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>2 , 2 , 4 --&gt; &lt;x i=2 4&gt; &lt;x i=2 3&gt; &lt;x i=2 3&gt; &lt;x i=2 4&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>3 , 1 , 3 --&gt; &lt;x i=3 3&gt;   &lt;x i=2 4&gt; &lt;x i=2 3&gt; &lt;x i=2 4&gt;   &lt;x i=3 3&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>3 , 2 , 4 --&gt; &lt;x i=3 4&gt;   &lt;x i=3 3&gt; &lt;x i=2 4&gt; &lt;x i=2 4&gt; &lt;x i=3 3&gt;   &lt;x i=3 4&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'>:)</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_text'>import module namespace ddl = &quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;1&lt;/</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;2&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>where</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>&gt;</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>2</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$c</span><span class='ace_text'> := </span><span class='ace_support ace_function'>count</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)) </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$j</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>order</span><span class='ace_text'> </span><span class='ace_keyword'>by</span><span class='ace_text'> </span><span class='ace_variable'>$c</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)[</span><span class='ace_variable'>$i</span><span class='ace_text'>]);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-first</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$c</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:insert-nodes-last</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, &lt;</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'> </span><span class='ace_meta ace_tag'>i</span><span class='ace_text'>=</span><span class='ace_string'>&quot;</span><span class='ace_text'>{</span><span class='ace_variable'>$i</span><span class='ace_text'>}</span><span class='ace_string'>&quot;</span><span class='ace_text'>&gt;{</span><span class='ace_variable'>$c</span><span class='ace_text'>}&lt;/</span><span class='ace_meta ace_tag'>x</span><span class='ace_text'>&gt;);</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_comment'>(:</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>i , j , c</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>2 , 1 , 3 --&gt; &lt;x i=2 3&gt; &lt;a&gt; &lt;x i=2 3&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>3 , 1 , 3 --&gt; &lt;x i=3 3&gt;   &lt;x i=2 3&gt; &lt;a&gt;   &lt;x i=3 3&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>2 , 2 , 4 --&gt; &lt;x i=2 4&gt;   &lt;x i=3 3&gt; &lt;a&gt; &lt;x i=3 3&gt;    &lt;x i=2 4&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'></span><span><br /><span class='ace_line'><span class='ace_comment'>3 , 2 , 4 --&gt; &lt;x i=3 4&gt;   &lt;x i=2 4&gt; &lt;x i=3 3&gt; &lt;x i=3 3&gt; &lt;x i=2 4&gt;    &lt;x i=3 4&gt;</span><span><br /><span class='ace_line'><span class='ace_comment'>:)</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> := </span><span class='ace_constant'>10</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_constant'>9</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>&gt;</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$y</span><span class='ace_text'> := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>=</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.my-annotation.com/&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> op = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/options/warnings&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>option</span><span class='ace_text'> op:disable </span><span class='ace_string'>&quot;all&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$local:foo1</span><span class='ace_text'> := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$local:foo2</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$local:foo3</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>2</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo4</span><span class='ace_text'> := </span><span class='ace_string'>&quot;foo&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>%ann:foo </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$local:foo5</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>%ann:foo1 %ann:foo2 </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$local:foo6</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> xs:integer := </span><span class='ace_constant'>2</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>(</span><span class='ace_variable'>$local:foo1</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo2</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo3</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo4</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo5</span><span class='ace_text'>, </span><span class='ace_variable'>$local:foo6</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:nonsequential %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_constant'>1</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:nonsequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$s</span><span class='ace_text'> := </span><span class='ace_support ace_function'>fn:max</span><span class='ace_text'>((</span><span class='ace_constant'>1</span><span class='ace_text'>,</span><span class='ace_constant'>2</span><span class='ace_text'>,</span><span class='ace_constant'>3</span><span class='ace_text'>))</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>exit</span><span class='ace_text'> </span><span class='ace_keyword'>returning</span><span class='ace_text'> (</span><span class='ace_string'>&quot;max:&quot;</span><span class='ace_text'>, </span><span class='ace_variable'>$s</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_string'>&quot;THIS IS THE SECRET&quot;</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> map = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/data-structures/unordered-map&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:nonsequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo() </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>map:create</span><span class='ace_text'>(</span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;local:mymap&quot;</span><span class='ace_text'>), </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;xs:integer&quot;</span><span class='ace_text'>));</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>updating</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test3()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    (</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>delete</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'>,</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span class='ace_text'>    )</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:test3</span><span class='ace_text'>(),</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_string'>&quot;,</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> xqsx = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/zorba/scripting&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ddl = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/ddl&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> dml = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/dynamic/collections/dml&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$col</span><span class='ace_text'> := </span><span class='ace_support ace_function'>xs:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;myCollection&quot;</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>updating</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:test3()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    (</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_support ace_function'>dml:delete-nodes</span><span class='ace_text'>(</span><span class='ace_variable'>$x</span><span class='ace_text'>),</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span class='ace_text'>    )</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>ddl:create</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>, (&lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;,&lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;&lt;/</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>&gt;));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>(</span><span><br /><span class='ace_line'><span class='ace_support ace_function'>xqsx:apply</span><span class='ace_text'>(</span><span class='ace_support ace_function'>local:test3</span><span class='ace_text'>()),</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_string'>&quot;</span><span><br /><span class='ace_line'><span class='ace_string'>&quot;,</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>dml:collection</span><span class='ace_text'>(</span><span class='ace_variable'>$col</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>)</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$sequence</span><span class='ace_text'> := (</span><span class='ace_constant'>65</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>90</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_variable'>$var</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:bar()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$rand</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$sequence</span><span class='ace_text'>[</span><span class='ace_variable'>$rand</span><span class='ace_text'>]</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:bar</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$sequence</span><span class='ace_text'> := (</span><span class='ace_constant'>65</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>90</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_variable'>$var</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:bar()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$rand</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$sequence</span><span class='ace_text'>[</span><span class='ace_variable'>$rand</span><span class='ace_text'>]</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:bar</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$sequence</span><span class='ace_text'> := (</span><span class='ace_constant'>65</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>90</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span class='ace_text'> := </span><span class='ace_variable'>$var</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$var</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:bar()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$i</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> (</span><span class='ace_constant'>1</span><span class='ace_text'> </span><span class='ace_keyword'>to</span><span class='ace_text'> </span><span class='ace_constant'>10</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>    {</span><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$rand</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>      </span><span class='ace_variable'>$sequence</span><span class='ace_text'>[</span><span class='ace_variable'>$rand</span><span class='ace_text'>]</span><span><br /><span class='ace_line'><span class='ace_text'>    }</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:bar</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:handle()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>local:handle-method</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>if</span><span class='ace_text'>(</span><span class='ace_support ace_function'>true</span><span class='ace_text'>()) </span><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>    ()</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>else</span><span class='ace_text'> ()</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %private </span><span class='ace_keyword'>function</span><span class='ace_text'> local:handle-method()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_support ace_function'>true</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:handle</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$cnt</span><span class='ace_text'> := </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$map</span><span class='ace_text'> := &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;&lt;</span><span class='ace_meta ace_tag'>b1</span><span class='ace_text'>/&gt;&lt;</span><span class='ace_meta ace_tag'>b2</span><span class='ace_text'>/&gt;&lt;/</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>&gt;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$repl</span><span class='ace_text'> := &lt;</span><span class='ace_meta ace_tag'>c</span><span class='ace_text'>/&gt;;</span><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$result</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> node()* := ();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>while</span><span class='ace_text'> (</span><span class='ace_variable'>$cnt</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>&lt;</span><span class='ace_constant'>3</span><span class='ace_text'>)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$cnt</span><span class='ace_text'> := </span><span class='ace_variable'>$cnt</span><span class='ace_text'> </span><span class='ace_keyword ace_operator'>+</span><span class='ace_text'> </span><span class='ace_constant'>1</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_variable'>$result</span><span class='ace_text'> := (</span><span class='ace_variable'>$result</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>              ,</span><span><br /><span class='ace_line'><span class='ace_text'>              </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$rec</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_variable'>$map</span><span class='ace_text'>/*</span><span><br /><span class='ace_line'><span class='ace_text'>              </span><span class='ace_keyword'>return</span><span><br /><span class='ace_line'><span class='ace_text'>              </span><span class='ace_keyword'>if</span><span class='ace_text'> ( </span><span class='ace_variable'>$repl</span><span class='ace_text'>[</span><span class='ace_support ace_function'>name</span><span class='ace_text'>() </span><span class='ace_keyword'>eq</span><span class='ace_text'> </span><span class='ace_support ace_function'>name</span><span class='ace_text'>(</span><span class='ace_variable'>$rec</span><span class='ace_text'>)] )</span><span><br /><span class='ace_line'><span class='ace_text'>              </span><span class='ace_keyword'>then</span><span class='ace_text'> ()</span><span><br /><span class='ace_line'><span class='ace_text'>              </span><span class='ace_keyword'>else</span><span class='ace_text'> </span><span class='ace_variable'>$rec</span><span class='ace_text'>);</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_variable'>$result</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>updating</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt;;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>   </span><span class='ace_keyword'>insert</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> &lt;</span><span class='ace_meta ace_tag'>b</span><span class='ace_text'>/&gt; </span><span class='ace_keyword'>into</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>();</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>()</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> x =</span><span><br /><span class='ace_line'><span class='ace_string'>&quot;http://www.zorba-xquery.com/modules/store/data-structures/unordered-map&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> ann = </span><span class='ace_string'>&quot;http://www.zorba-xquery.com/annotations&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> %ann:sequential </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>if</span><span class='ace_text'> (</span><span class='ace_support ace_function'>fn:true</span><span class='ace_text'>())</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>then</span><span><br /><span class='ace_line'><span class='ace_text'>  {</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$req</span><span class='ace_text'> := &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt;;</span><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$result</span><span class='ace_text'> := </span><span class='ace_support ace_function'>x:create</span><span class='ace_text'>(</span><span class='ace_support ace_function'>fn:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;http://www.zorba-xquery.com/map&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;first&quot;</span><span class='ace_text'>),</span><span><br /><span class='ace_line'><span class='ace_text'>                                 </span><span class='ace_support ace_function'>fn:QName</span><span class='ace_text'>(</span><span class='ace_string'>&quot;http://www.w3.org/2001/XMLSchema&quot;</span><span class='ace_text'>, </span><span class='ace_string'>&quot;xs:integer&quot;</span><span class='ace_text'>));</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_text'>    </span><span class='ace_variable'>$result</span><span><br /><span class='ace_line'><span class='ace_text'>  }</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>else</span><span><br /><span class='ace_line'><span class='ace_text'>  ()</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>let</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span class='ace_text'> := </span><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>()</span><span><br /><span class='ace_line'><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_variable'>$x</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>variable</span><span class='ace_text'> </span><span class='ace_variable'>$doc</span><span class='ace_text'> :=</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>root</span><span class='ace_text'>&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>n1</span><span class='ace_text'>/&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;</span><span class='ace_meta ace_tag'>n2</span><span class='ace_text'>/&gt;</span><span><br /><span class='ace_line'><span class='ace_text'>&lt;/</span><span class='ace_meta ace_tag'>root</span><span class='ace_text'>&gt;;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:boo()</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>declare</span><span class='ace_text'> </span><span class='ace_keyword'>function</span><span class='ace_text'> local:foo(</span><span class='ace_variable'>$nodes</span><span class='ace_text'> </span><span class='ace_keyword'>as</span><span class='ace_text'> node()*)</span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$n</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_variable'>$nodes</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span class='ace_support ace_function'>count</span><span class='ace_text'>((</span><span class='ace_variable'>$n</span><span class='ace_text'>/following-sibling::*[</span><span class='ace_constant'>1</span><span class='ace_text'>])/*)</span><span><br /><span class='ace_line'><span class='ace_text'>};</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>local:foo</span><span class='ace_text'>(</span><span class='ace_keyword'>for</span><span class='ace_text'> </span><span class='ace_variable'>$node</span><span class='ace_text'> </span><span class='ace_keyword'>in</span><span class='ace_text'> </span><span class='ace_variable'>$doc</span><span class='ace_text'>/*</span><span><br /><span class='ace_line'><span class='ace_text'>          </span><span class='ace_keyword'>return</span><span class='ace_text'> </span><span><br /><span class='ace_line'><span class='ace_text'>          {</span><span><br /><span class='ace_line'><span class='ace_text'>            </span><span class='ace_keyword'>insert</span><span class='ace_text'> </span><span class='ace_keyword'>node</span><span class='ace_text'> &lt;</span><span class='ace_meta ace_tag'>a</span><span class='ace_text'>/&gt; </span><span class='ace_keyword'>as</span><span class='ace_text'> </span><span class='ace_keyword'>first</span><span class='ace_text'> </span><span class='ace_keyword'>into</span><span class='ace_text'> </span><span class='ace_variable'>$node</span><span class='ace_text'>; </span><span><br /><span class='ace_line'><span class='ace_text'>            </span><span class='ace_variable'>$node</span><span><br /><span class='ace_line'><span class='ace_text'>          })</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_keyword'>while</span><span class='ace_text'>(</span><span class='ace_support ace_function'>true</span><span class='ace_text'>()) </span><span><br /><span class='ace_line'><span class='ace_text'>{</span><span><br /><span class='ace_line'><span class='ace_text'>  </span><span class='ace_keyword'>break</span><span class='ace_text'> </span><span class='ace_keyword'>loop</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span class='ace_text'>}</span><span><br /><span class='ace_line'><span><br /></pre><hr /><pre class='ace-tm'><span class='ace_line'><span class='ace_keyword'>import</span><span class='ace_text'> </span><span class='ace_keyword'>module</span><span class='ace_text'> </span><span class='ace_keyword'>namespace</span><span class='ace_text'> functx = </span><span class='ace_string'>&quot;http://www.functx.com/&quot;</span><span class='ace_text'>;</span><span><br /><span class='ace_line'><span><br /><span class='ace_line'><span class='ace_support ace_function'>functx:substring-before-last</span><span class='ace_text'>(</span><span class='ace_string'>'abc-def-ghi'</span><span class='ace_text'>, </span><span class='ace_string'>'-'</span><span class='ace_text'>)</span><span><br /></pre><hr /></body></html>